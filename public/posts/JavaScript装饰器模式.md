---
title: JavaScript è£…é¥°å™¨æ¨¡å¼ğŸŠ
date: 2021-03-09 20:36:26
tags: JavaScript
categories: ç¬”è®°
url: javascript-decorator
index_img: /images/JavaScriptè£…é¥°å™¨æ¨¡å¼/logo.webp
---

JavaScript çš„å‡½æ•°éå¸¸çµæ´»ï¼Œå®ƒä»¬å¯ä»¥è¢«ä¼ é€’ï¼Œç”¨ä½œå¯¹è±¡ã€‚é™¤äº† this éš¾ä»¥æ‰æ‘¸ä»¥å¤–ã€‚

## è£…é¥°å™¨

è£…é¥°ï¼ˆdecorateï¼‰ï¼Œå°†åŸå‡½æ•°ä½œä¸ºä¸€ä¸ªå‚æ•°ä¼ é€’ç»™è£…é¥°å™¨ã€‚åˆ©ç”¨å‡½æ•°é—­åŒ…çš„ç‰¹æ€§ï¼Œåœ¨çˆ¶ä½œç”¨åŸŸä¸­ä¿å­˜ä¸€äº›æ‰§è¡Œåçš„æ•°æ®ï¼ˆç¼“å­˜ï¼‰æˆ–æ‰§è¡Œä¸€äº›ç‰¹æ®Šæ“ä½œã€‚å†å°†å…¶è¿”å›å‡ºå»ï¼Œåœ¨è¿™ä¸ªè¿”å›çš„å‡½æ•°æ ¹æ®æ¡ä»¶æ¥æ‰§è¡ŒåŸå‡½æ•°ã€‚

åœ¨å®é™…å·¥ä½œä¸­å¸¸è§åˆ°çš„å‡½æ•°é˜²æŠ–å’ŒèŠ‚æµå°±æ˜¯è£…é¥°å™¨çš„å·¥ä½œåŸç†ã€‚

## ç¼“å­˜è£…é¥°å™¨

ä¸€ä¸ªç®€å•çš„é€æ˜ç¼“å­˜è£…é¥°å™¨å¯ä»¥æ˜ç¡®çš„è®©æˆ‘ä»¬äº†è§£åˆ°è£…é¥°å™¨çš„å·¥ä½œæ–¹å¼ï¼š

```js
// ä¸€ä¸ªå·¥ä½œç¼“æ…¢çš„ slow å‡½æ•°
function slow(ds) {
  return `${ds}`;
}

function cachingDcorator(fn) {
  // åˆ›å»ºä¸€ä¸ª map ç”¨äºç¼“å­˜
  let cache = new Map();
  // è¿”å›ä¸€ä¸ªé—­åŒ…
  return function(ds) {
    // æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦æœ‰ç»“æœ
    if (cache.has(ds)) {
      return cache.get(ds);
    }
    // æ²¡æœ‰ç¼“å­˜æ—¶ï¼Œæ‰§è¡ŒåŸå‡½æ•°ï¼Œå¹¶è®°å½•ç¼“å­˜
    let res = fn(ds);
    cache.set(ds, res);
    return res;
  }
}
// è£…é¥°
cacheSlow = cachingDcorator(slow);
console.log(cacheSlow('124'));
```

åœ¨è£…é¥°å™¨ cachingDcorator å†…ï¼Œçˆ¶ä½œç”¨åŸŸä¸­åˆ›å»ºäº†ä¸€ä¸ªåä¸º cache çš„ map ç»“æ„ï¼Œåˆ©ç”¨é—­åŒ…çš„ç‰¹æ€§å°±èƒ½å¤Ÿè®¿é—®è¿™ä¸ªç¼“å­˜å¯¹è±¡ã€‚

åœ¨æ¯æ¬¡æ‰§è¡Œæ—¶ï¼Œéƒ½å°†æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”çš„ç¼“å­˜ã€‚å¦‚æœæœ‰ï¼Œåˆ™è·³è¿‡æ‰§è¡ŒåŸå‡½æ•°ï¼Œç›´æ¥è¿”å›ç¼“å­˜çš„æ•°æ®ï¼Œä»¥å‡å°‘å‡½æ•°çš„æ‰§è¡Œå·¥ä½œã€‚

ä¸Šè¿°ç®€å•çš„é€æ˜ç¼“å­˜è£…é¥°å™¨è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå¸¦æœ‰ this æ—¶ä¼šå¤±æ•ˆã€‚

```js
let worker = {
  foo() {
    return 'å˜¤å˜¤å˜¤';
  },
  slow(ds) {
    return `${ds} ${this.foo()}`;
  }
}

function cachingDcorator(fn) {
  'use strict'
  let cache = new Map();

  return function(ds) {
    if (cache.has(ds)) {
      return cache.get(ds);
    }

    let res = fn(ds);
    cache.set(ds, res);
    return res;
  }
}

let worker.slow = cachingDcorator(worker.slow);
// undefined
console.log(worker.slow('xfy'));
```

å½“ä¸€ä¸ªå‡½æ•°è¢«ä¼ é€’åˆ°å…¶ä»–å˜é‡ä¸­ï¼Œå°†ä¸¢å¤±å…¶ä¸Šä¸‹æ–‡ thisã€‚

```js
let func = worker.slow;
func('xfy')
```

åŒç†ï¼Œç¼“å­˜è£…é¥°å™¨ä¹Ÿæ˜¯å°†å…¶å‡½æ•°ä½“ä½œä¸ºå‚æ•°ä¼ å…¥åˆ°æ–¹æ³•ä¸­ï¼Œå¯¼è‡´äº†å…¶ä¸¢å¤±äº†ä¸Šä¸‹æ–‡ thisã€‚æ‰€ä»¥è¿™æ ·çš„è£…é¥°å™¨åœ¨å¯¹è±¡ä¸­çš„æ–¹æ³•æ˜¯ç”¨ä¸äº†çš„ã€‚

## ä¼ é€’ this

### ä½¿ç”¨ call

ä½¿ç”¨ call å¯ä»¥è½»æ¾è§£å†³ this çš„é—®é¢˜ã€‚

```js
let worker = {
  foo() {
    return 'å˜¤å˜¤å˜¤';
  },
  slow(ds) {
    return `${ds} ${this.foo()}`;
  }
}

function cachingDcorator(fn) {
  let cache = new Map();

  return function(ds) {
    if (cache.has(ds)) {
      return cache.get(ds);
    }

    let res = fn.call(this, ds);
    cache.set(ds, res);
    return res;
  }
}

worker.slow = cachingDcorator(worker.slow);

console.log(worker.slow('xfy'));
```

åœ¨å°†å‡½æ•°ä½“ä¼ å›å¯¹è±¡æ—¶`worker.slow = cachingDcorator(worker.slow);`ï¼Œåœ¨è£…é¥°å™¨å†…éƒ¨ä½¿ç”¨äº† call æ¥æ‰§è¡Œä¼ é€’çš„å‚æ•°`fn.call(worker, ds);`ã€‚è¯¦ç»†çš„ä¼ é€’æ­¥éª¤ä¸ºï¼š

1. worker.slow è¢«ä¼ é€’ä¸ºåŒ…è£…å™¨`function (ds) { ... }`ï¼›
2. å‡½æ•°ä½œä¸ºå¯¹è±¡å±æ€§æ‰§è¡Œæ—¶ï¼Œ`this=worker`ã€‚ï¼ˆå®ƒæ˜¯ç‚¹ç¬¦å· . ä¹‹å‰çš„å¯¹è±¡ï¼‰ï¼›
3. åœ¨åŒ…è£…å™¨å†…éƒ¨ï¼Œå‡è®¾ç»“æœå°šæœªç¼“å­˜ï¼Œ`func.call(this, ds)`å°†å½“å‰çš„ `this`ï¼ˆ`=worker`ï¼‰å’Œå½“å‰çš„å‚æ•°ï¼ˆ`=xfy`ï¼‰ä¼ é€’ç»™åŸå§‹æ–¹æ³•ã€‚

## ä¼ é€’å¤šä¸ªå‚æ•°

åŸç”Ÿçš„ Map ä»…å°†å•ä¸ªå€¼ä½œä¸ºé”®ï¼ˆkeyï¼‰ã€‚å½“ç„¶å¯ä»¥ä½¿ç”¨å…¶ä»–çš„ç±»ä¼¼ map çš„æ•°æ®ç»“æ„æ¥å­˜å‚¨ç¼“å­˜çš„å€¼ï¼Œæˆ–è€…åœ¨ map ä¸­åµŒå¥— mapã€‚

è¿˜æœ‰ä¸€ç§è§£å†³æ–¹æ³•å°±æ˜¯ä½¿ç”¨ä¸€ä¸ª hash å‡½æ•°ï¼Œæ¥å°†ä¸¤ä¸ªå‚æ•°åšä¸ªç®€å•çš„è¿ç®—ï¼Œå°†å…¶åšä¸ºä¸€ä¸ªå€¼ä¿å­˜åœ¨ map çš„ key ä¸­ï¼Œå¹¶å¯¹åº”ç»“æœç¼“å­˜ã€‚

```js
let worker = {
  slow(x, y) {
    return x + y;
  },
};

function cachingDcorator(fn, hash) {
  let map = new Map();
  return function () {
    let key = hash(arguments);
    if (map.has(key)) {
      return map.get(key);
    }

    let res = fn.call(this, ...arguments);
    map.set(key, res);
    return res;
  };
}

function hash(args) {
  return `${args[0]}${args[1]}`;
}

worker.slow = cachingDcorator(worker.slow, hash);
console.log(worker.slow(2, 3));
```

åœ¨ JavaScript ä¸­ï¼Œå½¢å‚ä¸æ˜¯å¿…è¦çš„ã€‚åªè¦ä¼ é€’äº†å®é™…å‚æ•°ï¼Œé‚£ä¹ˆåœ¨å‡½æ•°ä¸­å°±èƒ½ä½¿ç”¨`arguments`è¿™ä¸ªç±»æ•°ç»„æ¥è·å–åˆ°æ‰€æœ‰çš„å‚æ•°ã€‚

æ‰€ä»¥åœ¨è¿™é‡Œè¿”å›çš„é—­åŒ…é‡Œä½¿ç”¨`let key = hash(arguments);`æ¥è·å–ä¸¤ä¸ªå‚æ•°åš hash è¿ç®—ã€‚

ç”±äºæ˜¯ä¸€ä¸ªç±»æ•°ç»„ï¼Œæ‰€ä»¥å®ƒä¹Ÿæ˜¯å¯è¿­ä»£çš„ã€‚åœ¨ä¼ ç»™åŸå‡½æ•°å‚æ•°æ—¶ï¼Œä½¿ç”¨äº†å±•å¼€ï¼ˆSpreadï¼‰è¯­æ³•`let res = fn.call(this, ...arguments);`æ¥å°†ç±»æ•°ç»„è¿­ä»£å¼€æ¥ã€‚


### ä½¿ç”¨ apply

åœ¨ä¼ é€’ this æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† call æ¥ä¼ é€’å‚æ•°ã€‚call æ¥å—å‚æ•°ä¸ºé€ä¸ªä¼ é€’ï¼Œåœ¨æ¥å—å¤šä¸ªå‚æ•°æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†å±•å¼€è¯­æ³•æ¥å°†å¯è¿­ä»£å¯¹è±¡çš„å‚æ•°ä¼ é€’ç»™ callã€‚

call ä¸ apply çš„å”¯ä¸€åŒºåˆ«å°±æ˜¯å‚æ•°çš„ä¼ é€’æ–¹å¼ä¸åŒã€‚apply æ¥å—å‰©ä½™çš„å‚æ•°ä¸ºä¸€ä¸ªç±»æ•°ç»„

æ‰€ä»¥è¿™é‡Œä¸¤ä¸ªè°ƒç”¨æ˜¯ç­‰ä»·çš„ï¼š

* `fn.call(this, ...arguments)`
* `fn.apply(this, arguments)`

è€Œå¯¹äºå³å¯è¿­ä»£åˆæ˜¯ç±»æ•°ç»„çš„å¯¹è±¡ï¼Œä¾‹å¦‚ä¸€ä¸ªçœŸæ­£çš„æ•°ç»„ï¼Œæˆ‘ä»¬ä½¿ç”¨ call æˆ– apply å‡å¯ï¼Œä½†æ˜¯ apply å¯èƒ½ä¼šæ›´å¿«ï¼Œå› ä¸ºå¤§å¤šæ•° JavaScript å¼•æ“åœ¨å†…éƒ¨å¯¹å…¶è¿›è¡Œäº†ä¼˜åŒ–ã€‚

å°†æ‰€æœ‰å‚æ•°è¿åŒä¸Šä¸‹æ–‡ä¸€èµ·ä¼ é€’ç»™å¦ä¸€ä¸ªå‡½æ•°è¢«ç§°ä¸ºâ€œå‘¼å«è½¬ç§»ï¼ˆcall forwardingï¼‰â€ã€‚

### æ–¹æ³•å€Ÿç”¨

èƒ½æ¥å—çš„å‚æ•°è¿˜ä¸å¤Ÿå¤šã€‚

ä¸Šè¿° hash æ–¹æ³•ä¸€æ¬¡åªèƒ½å¤„ç†ä¸¤ä¸ªå‚æ•°`return '${args[0]}${args[1]}'`ï¼Œå°†å…¶ä½œä¸º map çš„ä¸€ä¸ª key æ¥ä½¿ç”¨ã€‚å½“é‡åˆ°ä¸¤ä¸ªä»¥ä¸Šå‚æ•°æ—¶å°±æ— èƒ½ä¸ºåŠ›äº†ã€‚

æ‰€ä»¥è¿˜éœ€è¦å¯¹ hash æ–¹æ³•åšä¸€ä¸ªå°æ”¹è¿›ï¼Œä½¿å…¶èƒ½å¤Ÿä½¿ç”¨æ•°ç»„çš„`join()`æ–¹æ³•æ¥å°†æ‰€æœ‰çš„å‚æ•°åˆå¹¶ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

ç”±äºæ¥å—çš„å‚æ•°`arguments`æ˜¯ä¸€ä¸ªç±»æ•°ç»„ï¼Œæ‰€ä»¥å®ƒå¹¶æ²¡æœ‰æ•°ç»„çš„`join()`æ–¹æ³•ã€‚è¿™é‡Œå°±éœ€è¦åˆ©ç”¨ call æ¥æ”¹å˜ this çš„æŒ‡å‘ä»è€Œâ€œå€Ÿç”¨â€ä¸€ä¸‹æ•°ç»„çš„`join()`æ–¹æ³•ï¼š

```js
function hash(args) {
  // return Array.prototype.join.call(args);
  return [].join.call(args);
}
```

è¿™ç§æ–¹å¼ç§°ä¹‹ä¸º**æ–¹æ³•å€Ÿç”¨**ã€‚

æœ€å¸¸è§åˆ°çš„æ–¹æ³•å€Ÿç”¨å°±æ˜¯åˆ¤æ–­æ•°æ®ç±»å‹ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ typeof åœ¨åˆ¤æ–­å¼•ç”¨å€¼æ—¶æœ‰é‚£ä¹ˆä¸€ç‚¹ä¸å‡†ç¡®ï¼Œè¿™æ—¶å€™æœ‰ä¸€ä½å¤§ä½¬å´èƒ½å¤Ÿå‡†ç¡®çš„åˆ¤æ–­æ‰€æœ‰çš„ç±»å‹ï¼š`Object.prototype.toString()`æ–¹æ³•ã€‚

è¿™ä¸ªæ–¹æ³•åŸæœ¬æ˜¯ç”¨æ¥è½¬æ¢ä¸ºå­—ç¬¦ä¸²çš„ï¼Œä½†é€šè¿‡å€Ÿç”¨å®ƒè¿˜èƒ½ [åˆ¤æ–­æ•°æ®ç±»å‹](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/toString#%E4%BD%BF%E7%94%A8_tostring()_%E6%A3%80%E6%B5%8B%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B)ã€‚

```js
Object.prototype.toString.call(new Array())
// "[object Array]"
typeof new Array()
// "object"
```

> è¿˜æœ‰ä¸€ç§åˆ¤æ–­æ•°æ®ç±»å‹çš„æ–¹æ³•æ˜¯ï¼š`xxx.construtor.name`


## å‡½æ•°å±æ€§

é€šå¸¸ï¼Œå‡½æ•°è£…é¥°å™¨æ˜¯å®‰å…¨çš„ã€‚ä¸è¿‡å½“é‡åˆ°åŸå‡½æ•°æ‹¥æœ‰è‡ªèº«çš„å±æ€§æ—¶ï¼Œé€šè¿‡è£…é¥°å™¨è¿”å›çš„å‡½æ•°å°±ä¼šå¯¼è‡´å…¶ä¸¢å¤±è‡ªèº«çš„å±æ€§ã€‚ä¾‹å¦‚ï¼š`foo.count`ã€‚

ä¸€äº›åŒ…è£…å™¨å¯èƒ½ä¹Ÿä¼šåŒ…å«è‡ªèº«çš„å±æ€§ï¼Œä¾‹å¦‚è®°å½•å‡½æ•°è¢«è°ƒç”¨çš„æ¬¡æ•°æˆ–è€…å…¶ä»–çš„ä¿¡æ¯ã€‚

å¯ä»¥ä½¿ç”¨ Proxy å¯¹è±¡æ¥åŒ…è£…å‡½æ•°ï¼Œæ¥ä¿ç•™å‡½æ•°å±æ€§çš„è®¿é—®æƒã€‚Proxy éå¸¸å¼ºå¤§ï¼ŒVue 3 å°±æ˜¯ä½¿ç”¨ Proxy æ¥åˆ›å»ºå“åº”å¼å¯¹è±¡çš„ã€‚ä»è€Œè§£å†³äº† Vue 2 ä¸èƒ½ç›‘å¬åˆ°å¯¹è±¡æ–°å¢å±æ€§çš„é—®é¢˜ç­‰ã€‚

## å®ä¾‹

ä¸€äº›è£…é¥°å™¨çš„å®ä¾‹ï¼Œè¿™æ®µå†…å®¹ä¹Ÿæ˜¯ javascript.info çš„ [ä»»åŠ¡](https://zh.javascript.info/call-apply-decorators#tasks)

### é—´è°è£…é¥°å™¨

é—´è°è£…é¥°å™¨ä¿å­˜æ¯æ¬¡å‡½æ•°è°ƒç”¨æ—¶ä¼ é€’çš„å‚æ•°ä¸ºä¸€ä¸ªæ•°ç»„ã€‚è¿™ç§è£…é¥°å™¨æœ‰æ—¶å¯¹äºå•å…ƒæµ‹è¯•å¾ˆæœ‰ç”¨ã€‚å®ƒçš„é«˜çº§å½¢å¼æ˜¯ [Sinon.JS](https://sinonjs.org/) åº“ä¸­çš„`sinon.spy`ã€‚

```js
function work(x, y) {
  console.log(x, y);
}

function spy(fn) {
  function ret() {
    // æ¯æ¬¡è°ƒç”¨åŸå‡½æ•°æ—¶ï¼Œpush å‚æ•°åˆ° calls å±æ€§ä¸Š
    ret.calls.push(`calls:${[].join.call(arguments)}`);
    fn.apply(this, arguments);
  }
  // åœ¨è¿”å›çš„å‡½æ•°ä¸Šå®šä¹‰ä¸€ä¸ªå±æ€§ calls
  ret.calls = [];

  return ret;
}

work = spy(work); 

work(1, 2);
work(3, 4);
console.log(work.calls);
```

### å»¶æ—¶è£…é¥°å™¨

è¿™æ˜¯ä¸ªéå¸¸ç®€å•çš„è£…é¥°å™¨ï¼Œç”¨äºä¸ºå‡½æ•°è®¾ç½®ä¸€ä¸ªå»¶æ—¶åæ‰§è¡Œã€‚

```js
function foo(x) {
  console.log(x);
}

function delayRun(fn, ms) {
  return function() {
    setTimeout(() => {
      // ä¿æŒ this çš„æŒ‡å‘
      fn.apply(this, arguments);
    }, ms);
  }
}

foo = delayRun(foo, 500);

foo('xfy');
```

### é˜²æŠ–è£…é¥°å™¨

é˜²æŠ–è£…é¥°å™¨ debounce æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„æ–¹æ³•ã€‚å®ƒçš„ä¸»è¦ç›®çš„æ˜¯ä¿è¯åŸå‡½æ•°åœ¨ä¸€å®šæ—¶é—´å†…çš„è¿ç»­è°ƒç”¨åªç”Ÿæ•ˆä¸€æ¬¡ã€‚

é€šå¸¸åœ¨å®é™…ä¸­çš„ä½œç”¨æ˜¯ï¼šå‡è®¾ç”¨æˆ·è¾“å…¥äº†ä¸€äº›å†…å®¹ï¼Œæˆ‘ä»¬æƒ³è¦åœ¨ç”¨æˆ·è¾“å…¥å®Œæˆæ—¶å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚ã€‚

æˆ‘ä»¬æ²¡æœ‰å¿…è¦ä¸ºæ¯ä¸€ä¸ªå­—ç¬¦çš„è¾“å…¥éƒ½å‘é€è¯·æ±‚ã€‚ç›¸åï¼Œæˆ‘ä»¬æƒ³è¦ç­‰ä¸€æ®µæ—¶é—´ï¼Œç„¶åå¤„ç†æ•´ä¸ªç»“æœã€‚

åœ¨ Web æµè§ˆå™¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸ªäº‹ä»¶å¤„ç†ç¨‹åº â€”â€” ä¸€ä¸ªåœ¨æ¯æ¬¡è¾“å…¥å†…å®¹å‘ç”Ÿæ”¹åŠ¨æ—¶éƒ½ä¼šè°ƒç”¨çš„å‡½æ•°ã€‚é€šå¸¸ï¼Œç›‘å¬æ‰€æœ‰æŒ‰é”®è¾“å…¥çš„äº‹ä»¶çš„å¤„ç†ç¨‹åºä¼šè¢«è°ƒç”¨çš„éå¸¸é¢‘ç¹ã€‚ä½†å¦‚æœæˆ‘ä»¬ä¸ºè¿™ä¸ªå¤„ç†ç¨‹åºåšä¸€ä¸ª 1000ms çš„ debounce å¤„ç†ï¼Œå®ƒä»…ä¼šåœ¨æœ€åä¸€æ¬¡è¾“å…¥åçš„ 1000ms åè¢«è°ƒç”¨ä¸€æ¬¡ã€‚

```js
function foo(x) {
  console.log(x);
}

function debounce(fn, ms) {
  let timer = null;
  return function () {
    // å¦‚æœå»¶æ—¶å†…é¢‘ç¹è¢«è°ƒç”¨ï¼Œåˆ™å–æ¶ˆå»¶æ—¶ï¼Œä¸æ‰§è¡Œ
    if (timer) clearTimeout(timer);
    // å»¶æ—¶æ‰§è¡Œ
    timer = setTimeout(() => {
      fn.apply(this, arguments);
    }, ms);
  };
}

foo = debounce(foo, 1000);

foo(1);
foo(1);
foo(1);
```

### èŠ‚æµè£…é¥°å™¨

èŠ‚æµè£…é¥°å™¨ throttle å’Œé˜²æŠ–è£…é¥°å™¨å¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯å®ƒè¦å¤æ‚ä¸€ç‚¹ã€‚ä¸é˜²æŠ–ä¸åŒçš„æ˜¯ï¼ŒèŠ‚æµçš„ä¸»è¦ä½œç”¨æ˜¯ï¼šè®©å‡½æ•°ä¿æŒä¸€å®šçš„**æ—¶é—´é—´éš”**è¢«è°ƒç”¨æ‰§è¡Œã€‚

* `debounce`ä¼šåœ¨â€œå†·å´ï¼ˆcooldownï¼‰â€æœŸåè¿è¡Œå‡½æ•°ä¸€æ¬¡ã€‚é€‚ç”¨äºå¤„ç†æœ€ç»ˆç»“æœã€‚
* `throttle`è¿è¡Œå‡½æ•°çš„é¢‘ç‡ä¸ä¼šå¤§äºæ‰€ç»™å®šçš„æ—¶é—´ ms æ¯«ç§’ã€‚é€‚ç”¨äºä¸åº”è¯¥ç»å¸¸è¿›è¡Œçš„å®šæœŸæ›´æ–°ã€‚

```js
function foo(x) {
  console.log(x);
}

function throttle(fn, ms) {
  // åˆå§‹çŠ¶æ€ä¸ºä¸èŠ‚æµ
  let isThrottle = false,
    savedArgs,
    savedCont;

  function wrapper() {
    // å¦‚æœèŠ‚æµæ˜¯æ‰“å¼€çš„ï¼Œåˆ™ä¿å­˜å½“å‰è¿è¡Œçš„ä¸Šä¸‹æ–‡å’Œå‚æ•°
    if (isThrottle) {
      savedArgs = arguments;
      savedCont = this;
      return;
    }
    // ç¬¬ä¸€æ¬¡ç›´æ¥è¿è¡ŒåŸå‡½æ•°
    fn.apply(this, arguments);
    // ç¬¬ä¸€æ¬¡è¿è¡Œå®Œåæ‰“å¼€èŠ‚æµ
    isThrottle = true;

    setTimeout(() => {
      // åœ¨èŠ‚æµæ—¶é—´åå…³é—­èŠ‚æµé˜€
      isThrottle = false;
      if (savedArgs) {
        // è°ƒç”¨ wrapper è‡ªèº«ï¼Œå¹¶ä¼ é€’ä¿å­˜çš„ä¸Šä¸‹æ–‡
        wrapper.apply(savedCont, savedArgs);
        savedArgs = savedCont = null;
      }
    }, ms);
  }
  return wrapper;
}

let f1000 = throttle(foo, 1000);

f1000(1);
f1000(2);
f1000(3);
f1000(4);
f1000(5);
f1000(6);
setTimeout(() => {
  f1000(7);
}, 500);
setTimeout(() => {
  f1000(8);
}, 1000);
setTimeout(() => {
  f1000(9);
}, 1520);
setTimeout(() => {
  f1000('a');
}, 2000);
setTimeout(() => {
  f1000('b');
}, 2500);
setTimeout(() => {
  f1000('c');
}, 3000);
```

## å‚è€ƒ

* [è£…é¥°å™¨æ¨¡å¼å’Œè½¬å‘ï¼Œcall/apply](https://zh.javascript.info/call-apply-decorators)
* [Object.prototype.toString()](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/toString)