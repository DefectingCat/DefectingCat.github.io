<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/images/img/apple-touch-icon.webp"><link rel="icon" type="image/png" href="/images/img/favicon.webp"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#9DC8C8"><meta name="description" content=""><meta name="author" content="Defectink"><meta name="keywords" content=""><title>Docker-æ„å»ºå±äºè‡ªå·±çš„é•œåƒ - ğŸ­Defectink</title><link rel="stylesheet" href="https://cdn.defectink.com/static/twitter-bootstrap/4.5.3/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.defectink.com/static/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.defectink.com/static/highlight.js/10.0.0/styles/github-gist.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="https://cdn.defectink.com/static/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/xfy.css"><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/xml/atom.xml" title="ğŸ­Defectink" type="application/atom+xml"><link rel="alternate" href="/xml/rss.xml" title="ğŸ­Defectink" type="application/rss+xml"></head><body><header style="height:75vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>ğŸ­Defectink</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/">ğŸ  é¦–é¡µ</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">ğŸ“• ç´¢å¼•</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/categories/">ğŸ åˆ†ç±»</a> <a class="dropdown-item" href="/tags/">ğŸ æ ‡ç­¾</a></div></li><li class="nav-item"><a class="nav-link" href="/archives/">ğŸ“‚ å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/about/">ğŸƒ å…³äº</a></li><li class="nav-item"><a class="nav-link" href="/links/">ğŸ™†â€â™€ï¸ å°ä¼™ä¼´</a></li><li class="nav-item"><a class="nav-link" href="/pgp/">ğŸ” PGP</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner intro-2" id="background" parallax="true" style="background:url(/images/img/post.webp) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container page-header text-center fade-in-up"><span class="h2" id="subtitle"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Defectink</span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2019-11-29 09:30" pubdate>2019å¹´11æœˆ29æ—¥ ä¸Šåˆ</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 4.3k å­—</span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 54 åˆ†é’Ÿ</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto" id="post"><h1 style="display:none">Docker-æ„å»ºå±äºè‡ªå·±çš„é•œåƒ</h1><p class="note note-info">æœ¬æ–‡æœ€åæ°´äºï¼š2020å¹´11æœˆ2æ—¥ å‡Œæ™¨</p><div class="markdown-body" id="post-body"><p>ä»¥å‰ä¸€ç›´åœ¨ä½¿ç”¨åˆ«äººæ„å»ºå¥½çš„é•œåƒæ¥ä½¿ç”¨Dockerå®¹å™¨ï¼Œåœ¨ä¸€æ¬¡æƒ³æ­å»ºä¸€ä¸ªå®Œæ•´çš„Webç¯å¢ƒæ—¶ï¼Œå‘ç°ä½¿ç”¨è¿‡å¤šå®¹å™¨éå¸¸éš¾ä»¥ç®¡ç†ã€‚å¹¶ä¸”å®¹å™¨ä¹‹é—´çš„äº¤äº’é€šä¿¡å˜çš„å›°éš¾ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Docker Composeæ¥æ†ç»‘å¤šä¸ªé•œåƒè¿è¡Œï¼›ä¸è¿‡å¯¹äºè¿è¡ŒæœåŠ¡è¾ƒå°‘çš„æ¥è¯´ï¼Œä½¿ç”¨Dockerfileæ¥æ„å»ºæˆä¸€ä¸ªé•œåƒä¹Ÿæ˜¯ä»¶å¥½äº‹ã€‚</p><h2 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h2><p>é¦–å…ˆï¼Œåœ¨æ„å»ºä¸€ä¸ªé•œåƒä¹‹å‰ï¼Œéœ€è¦å…ˆæ˜ç™½è¿™ä¸ªé•œåƒå°†ä¼šåŒ…å«å“ªäº›ä¸œè¥¿ï¼Œè¿è¡Œå“ªäº›æœåŠ¡ã€‚ç›®å‰ä¸»è¦æ˜¯æƒ³åœ¨å½“å‰æœºå™¨ä¸Šè·‘ä¸€ä¸ªhexoçš„blogã€‚å½“ç„¶å¯ä»¥éƒ¨ç½²åœ¨Githubï¼Œä»¥å‰è¿˜å†™è¿‡ä¸€ç¯‡å…³äºéƒ¨ç½²åœ¨Githubçš„<a href="https://www.defectink.com/defect/set-up-the-hexo-blog.html">æ°´æ–‡</a>ã€‚ä¸è¿‡ç°åœ¨çš„æƒ³æ³•æ˜¯Githubæ”¾ä¸€ä»½ï¼Œåœ¨æœ¬åœ°æœåŠ¡å™¨ä¸Šä¹Ÿè·‘ä¸€ä¸ªServerã€‚</p><p>å½“ç„¶è·‘ä¸€ä¸ªhexoæ˜¯ä¸€ä»¶å¾ˆç®€å•çš„äº‹æƒ…ï¼Œä½¿ç”¨Dockeræ¥éƒ¨ç½²ä¹Ÿæ˜¯ä¸ºäº†æƒ³ä½“éªŒä¸€ä¸‹å†™<code>Dockerfile</code>ã€‚ç›®å‰æœ‰ä¸¤ä¸ªæ€è·¯ï¼š</p><ol><li><p>æŠŠnode.jså’Œhexoéƒ½éƒ¨ç½²åœ¨å½“å‰çš„å®¿ä¸»æœºï¼Œç”¨Dockerçš„WebæœåŠ¡å™¨æ¥è·‘å®¿ä¸»æœºç”Ÿæˆçš„é™æ€æ–‡ä»¶ã€‚</p><blockquote><p>ä½†æ˜¯è¿™æ ·çš„è¯å°±ä¸éœ€è¦ç”¨åˆ°Dockerfileäº†ï¼Œç›´æ¥pullä¸€ä¸ªhttpæœåŠ¡çš„é•œåƒå°±å¥½äº†ã€‚</p></blockquote></li><li><p>åªåœ¨å®¿ä¸»æœºä¸Šä½¿ç”¨Gitæ¥å’ŒGithubåŒæ­¥æ–‡ä»¶ï¼Œæ¯æ¬¡çš„ç”Ÿæˆå’Œè¿è¡ŒWebæœåŠ¡éƒ½æ”¾åœ¨Dockerå®¹å™¨é‡Œã€‚</p><blockquote><p>ç›®å‰æ‰“ç®—å°è¯•çš„ä¸€ç§æ–¹å¼ï¼Œå¯ä»¥åœ¨æ¯æ¬¡å†™å®Œæ–‡ç« åä½¿ç”¨Dockeræ„å»ºï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥å°è¯•Dockerfileäº†ã€‚</p></blockquote></li></ol><p>å…·ä½“éœ€è¦ä»€ä¹ˆä½¿ç”¨è½¯ä»¶ï¼Œå®Œå…¨çœ‹è‡ªå·±çš„éœ€æ±‚ï¼Œéœ€è¦ç”¨åˆ°ä»€ä¹ˆï¼Œå°±å®‰è£…ä»€ä¹ˆã€‚å°±åƒåœ¨å½“å‰çš„å®¿ä¸»æœºä¸Šå®‰è£…è½¯ä»¶ä¸€æ ·ã€‚åªä¸è¿‡æ˜¯ä½¿ç”¨Dockerfileæ¥æ„å»ºæ—¶å®‰è£…çš„è€Œå·²ã€‚</p><h2 id="æ„å»ºè‡ªå·±çš„é•œåƒ"><a href="#æ„å»ºè‡ªå·±çš„é•œåƒ" class="headerlink" title="æ„å»ºè‡ªå·±çš„é•œåƒ"></a>æ„å»ºè‡ªå·±çš„é•œåƒ</h2><p>å¥½åœ¨è¿˜å¯ä»¥ä½¿ç”¨Dockerfileæ¥åŸºäºå…¶ä»–çš„é•œåƒæ¥æ„å»ºå±äºè‡ªå·±çš„é•œåƒã€‚å¯ä»¥åœ¨å…¶ä»–çš„ç³»ç»ŸåŸºç¡€é•œåƒä¸Šæ¥åœ¨æ„å»ºæ—¶å°±å®‰è£…è‡ªå·±éœ€è¦çš„è½¯ä»¶æœåŠ¡ç­‰ï¼Œè¿™æ ·å°±å¯ä»¥æ„å»ºä¸€ä¸ªè‡ªå·±éœ€è¦çš„é•œåƒäº†ã€‚</p><h3 id="ä½¿ç”¨åŸºç¡€é•œåƒ"><a href="#ä½¿ç”¨åŸºç¡€é•œåƒ" class="headerlink" title="ä½¿ç”¨åŸºç¡€é•œåƒ"></a>ä½¿ç”¨åŸºç¡€é•œåƒ</h3><p>æ„å»ºæ—¶ä½¿ç”¨çš„ç¬¬ä¸€ä¸ªå‘½ä»¤æ˜¯<code>FROM</code>å‘½ä»¤ã€‚å®ƒä¼šæŒ‡å®šä¸€ä¸ªç”¨äºæ„å»ºçš„åŸºç¡€é•œåƒã€‚è¿™æ ·å°±å¯ä»¥åœ¨åŸºç¡€é•œåƒä¸­ä½¿ç”¨è‡ªå·±å–œæ¬¢çš„å‘è¡Œç‰ˆï¼Œä¹Ÿè§£å†³äº†ç»§æ‰¿å…¶ä»– Docker é•œåƒçš„é€”å¾„ ã€‚</p><p>åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œæˆ–è€…<code>clone</code>ä¸€ä¸ªhexoåšå®¢ç­‰ï¼Œåœ¨ç›®å½•å†…ç¼–å†™ä¸€ä¸ª<code>Dockerfile</code>ã€‚</p><pre><code class="hljs dockerfile"><span class="hljs-comment">#test</span>
  
<span class="hljs-keyword">FROM</span> alpine:latest
<span class="hljs-keyword">MAINTAINER</span> Defectink &lt;i@defect.ink&gt;</code></pre><p>è¿™é‡Œé€‰æ‹©çš„æ˜¯alpineç³»ç»Ÿä½œä¸ºåŸºç¡€é•œåƒï¼Œä¸»è¦åŸå› æ˜¯alpineæ˜¯ä¸ªè¶…çº§è½»é‡çš„ç³»ç»Ÿï¼Œå¯¹äºæœ€ä¸ºåŸºç¡€é•œåƒå¯ä»¥æœ‰æ•ˆçš„å‡å°‘æ„å»ºåé•œåƒçš„å¤§å°ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸ª<code>MAINTAINER</code>å‘½ä»¤ï¼Œå®ƒæ˜¯ç”¨æ¥è‘—åå½“å‰Dockerfileçš„ä½œè€…çš„ã€‚Dockeræ”¯æŒ<code>#</code>ä½œä¸ºæ³¨é‡Šï¼Œä½¿ç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ã€‚</p><h3 id="ç¬¬ä¸€æ¬¡çš„æ„å»º"><a href="#ç¬¬ä¸€æ¬¡çš„æ„å»º" class="headerlink" title="ç¬¬ä¸€æ¬¡çš„æ„å»º"></a>ç¬¬ä¸€æ¬¡çš„æ„å»º</h3><p>ç¼–å†™äº†ä¸€ä¸ªæœ€åŸºæœ¬çš„<code>Dockerfile</code>ä¹‹åï¼Œå°±æ˜¯è¿è¡Œç¬¬ä¸€æ¬¡çš„æ„å»ºæµ‹è¯•äº†ã€‚ä½¿ç”¨<code>Docker</code>åŠ ä¸Š<code>build</code>æ¥æ„å»ºæŒ‡å®šçš„<code>Dockerfile</code>ä¸ºé•œåƒã€‚æ·»åŠ <code>-t</code>å‚æ•°æ¥ä¸ºæ„å»ºåçš„é•œåƒæŒ‡å®šä¸€ä¸ªtagæ ‡ç­¾ï¼Œä¹Ÿå°±æ˜¯ä¹‹åçš„é•œåƒ(REPOSITORY)åã€‚æœ€åå‘½ä»¤æŒ‡å®šçš„ç›®å½•æ˜¯åŒ…å«åˆšåˆšå†™å¥½çš„<code>Dockerfile</code>æ–‡ä»¶çš„ç›®å½•ï¼Œè¢«ç§°ä½œä¸ºâ€œæ„å»ºç›®å½•â€ã€‚</p><p>å½“å‰ç³»ç»Ÿä¸‹æ²¡æœ‰åŸºç¡€é•œåƒalpineçš„è¯ï¼Œåœ¨ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶dockerä¹Ÿä¼šè¿›è¡Œä¸‹è½½ã€‚</p><pre><code class="hljs bash"><span class="hljs-comment"># docker build -t blog /data/github/DefectingCat.github.io/                                          </span>
Sending build context to Docker daemon     64kB
Step 1/2 : FROM alpine:latest
latest: Pulling from library/alpine
89d9c30c1d48: Pull complete 
Digest: sha256:c19173c5ada610a5989151111163d28a67368362762534d8a8121ce95cf2bd5a
Status: Downloaded newer image <span class="hljs-keyword">for</span> alpine:latest
 ---&gt; 965ea09ff2eb
Step 2/2 : MAINTAINER Defectink &lt;i@defect.ink&gt;
 ---&gt; Running <span class="hljs-keyword">in</span> d572ac48c8f8
Removing intermediate container d572ac48c8f8
 ---&gt; b8296646acaa
Successfully built b8296646acaa
Successfully tagged blog:latest</code></pre><p>ç¬¬ä¸€æ¬¡çš„é•œåƒæ„å»ºå·²ç»å®Œæˆäº†ï¼Œè™½ç„¶ä»€ä¹ˆéƒ½æ²¡æœ‰è¿›è¡Œå®šåˆ¶ï¼Œä½†å·²ç»è¿ˆå‡ºäº†ç¬¬ä¸€æ­¥ã€‚</p><h3 id="å®‰è£…è½¯ä»¶"><a href="#å®‰è£…è½¯ä»¶" class="headerlink" title="å®‰è£…è½¯ä»¶"></a>å®‰è£…è½¯ä»¶</h3><p>è¿ˆå‡ºç¬¬ä¸€æ­¥ä¹‹åï¼Œå°±å¯ä»¥å¼€å§‹è€ƒè™‘å®šåˆ¶å±äºè‡ªå·±çš„é•œåƒäº†ã€‚ä½¿ç”¨<code>docker images</code>å¯ä»¥æŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸‹çš„dockeré•œåƒã€‚ä¹Ÿèƒ½çœ‹åˆ°åˆšåˆšæ‰€æ„å»ºçš„ç¬¬ä¸€ä¸ªé•œåƒã€‚</p><pre><code class="hljs bash"><span class="hljs-comment"># docker images                                                                                      </span>
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
blog                latest              b8296646acaa        19 minutes ago      5.55MB
alpine              latest              965ea09ff2eb        5 weeks ago         5.55MB</code></pre><p>æ—¢ç„¶æ˜¯å®šåˆ¶å±äºè‡ªå·±çš„é•œåƒï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯éœ€è¦å®‰è£…æ‰€éœ€æ±‚çš„è½¯ä»¶çš„ã€‚è¿™é‡Œæˆ‘æƒ³æ„å»ºä¸€ä¸ªè¿è¡Œhexoçš„é•œåƒï¼Œæ‰€ä»¥è‡³å°‘éœ€è¦3æ¬¾è½¯ä»¶ï¼š</p><ul><li>apache</li><li>node.js</li><li>hexo</li></ul><p>ä½¿ç”¨<code>RUN</code>å‘½ä»¤æ¥åœ¨åŸºç¡€é•œåƒä¸Šæ‰§è¡Œå‘½ä»¤ï¼Œåƒæ˜¯å®‰è£…è½¯ä»¶ç­‰æ“ä½œã€‚ç”±äºalpineé»˜è®¤æ—¶åŒºä¸æ˜¯å›½å†…ï¼Œè¿˜å¯ä»¥é¡ºä¾¿ä¿®æ”¹ä¸‹æ—¶åŒºã€‚å¯ä»¥ä½¿ç”¨<code>RUN</code>æ¥ä¸€æ¬¡å®‰è£…å®Œæ‰€æœ‰éœ€è¦çš„è½¯ä»¶ï¼Œä¸éœ€è¦åˆ†å¼€æ‰§è¡Œã€‚</p><p>ä½¿ç”¨alpineçš„å¦ä¸ªåŸå› å°±æ˜¯åœ¨å®ƒæœ¬èº«ä½“ç§¯å°çš„æƒ…å†µä¸‹ï¼Œå®ƒå®‰è£…è½¯ä»¶è¿˜å¯ä»¥ä½¿ç”¨<code>--no-cache</code>æ¥å‡å°‘ç¼“å­˜ã€‚</p><p>åœ¨å®¹å™¨å†…ä½¿ç”¨npmæ¥å®‰è£…hexoæ—¶ä¼šå‡ºç°ä¸€ä¸ª<code>uid:0</code>çš„é—®é¢˜ï¼Œnpmä¼šæœ‰ç”Ÿå‘½å‘¨æœŸï¼ŒæŸä¸ªåŒ…ä¼šæœ‰ç”Ÿå‘½å‘¨æœŸæ¥æ‰§è¡Œä¸€äº›ä¸œè¥¿ï¼Œå®‰å…¨èµ·è§ä¼šè‡ªåŠ¨é™çº§å¯¼è‡´æ²¡æœ‰æƒé™æ‰§è¡Œä¸€äº›æ“ä½œï¼Œé€šè¿‡``â€“unsafe-perm`å‚æ•°æ¥è§£é”è¯¥é™åˆ¶ã€‚</p><pre><code class="hljs dockerfile"><span class="hljs-comment">#install</span>
<span class="hljs-keyword">RUN</span><span class="bash"> apk update \</span>
<span class="bash">        &amp;&amp; apk upgrade \</span>
<span class="bash">        &amp;&amp; apk add --no-cache \</span>
<span class="bash">        apache2 \</span>
<span class="bash">        nodejs \</span>
<span class="bash">        npm \</span>
<span class="bash">        tzdata \</span>
<span class="bash">        &amp;&amp; cp -r -f /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span>
<span class="bash">        &amp;&amp; rm -rf /var/cache/apk/* \</span>
<span class="bash">        &amp;&amp; mkdir -p /data/DefectingCat.github.io \</span>
<span class="bash">        &amp;&amp; npm config <span class="hljs-built_in">set</span> unsafe-perm <span class="hljs-literal">true</span> \</span>
<span class="bash">        &amp;&amp; npm install -g hexo</span></code></pre><p>å› ä¸ºæ˜¯åŸºäºä¸€ä¸ªæ“ä½œç³»ç»Ÿä¸Šæ„å»ºçš„é•œåƒï¼Œæ‰€ä»¥åœ¨æ„å»ºå®Œæˆåå¯ä»¥ä½¿ç”¨Dockeræ¥è¿è¡Œä¸€ä¸ªâ€œä¼ªç»ˆç«¯â€ï¼Œè®©æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ç»ˆç«¯å†…è¿›è¡Œä¸€äº›ä¿®æ”¹å’ŒæŸ¥çœ‹ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨â€œä¼ªç»ˆç«¯â€é‡Œè¿›è¡Œçš„æ“ä½œåªæ˜¯åœ¨å½“å‰å®¹å™¨å†…çš„ï¼Œä¸ä¼šè¢«å†™å…¥é•œåƒã€‚å½“å‰è¢«å…³é—­åï¼Œä»»ä½•æ“ä½œå°†ä¸å¤å­˜åœ¨ã€‚</p><p>åœ¨æ„å»ºå®Œåå¯ä»¥ä½¿ç”¨â€œä¼ªç»ˆç«¯â€è¿›å…¥ç³»ç»Ÿå†…æŸ¥çœ‹ä¸€äº›ä¿¡æ¯ï¼Œæµ‹è¯•è½¯ä»¶èƒ½å¦æ­£å¸¸å·¥ä½œç­‰ã€‚</p><pre><code class="hljs bash">docker run -it --rm blog</code></pre><p>å…³äºè¿™é‡Œçš„ä¸€äº›å‚æ•°ï¼š</p><ul><li><p><code>-i</code>å³ä½¿æ²¡æœ‰é™„åŠ ä¹Ÿä¿æŒSTDIN æ‰“å¼€ã€‚</p></li><li><p><code>-t</code>åˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯ã€‚</p></li><li><p><code>--rm</code>åœ¨é€€å‡ºåç«‹åˆ»åˆ é™¤å®¹å™¨ã€‚</p></li></ul><h3 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h3><pre><code class="hljs bash"><span class="hljs-comment"># docker build -t blog /data/github/DefectingCat.github.io/                                          </span>
Sending build context to Docker daemon     64kB
Step 1/5 : FROM alpine:latest
 ---&gt; 965ea09ff2eb
Step 2/5 : MAINTAINER Defectink &lt;i@defect.ink&gt;
 ---&gt; Using cache
 ---&gt; 92cd04f91315</code></pre><p>åœ¨æ„å»ºçš„æ—¶å€™å¯ä»¥åœ¨æŸä¸€æ­¥(Step)ä¸‹çœ‹åˆ°<code>Using cache</code>ã€‚ å½“ Docker æ„å»ºé•œåƒæ—¶ï¼Œå®ƒä¸ä»…ä»…æ„å»ºä¸€ä¸ªå•ç‹¬çš„é•œåƒï¼›äº‹å®ä¸Šï¼Œåœ¨æ„å»ºè¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šæ„å»ºè®¸å¤šé•œåƒã€‚</p><p>è¾“å‡ºä¿¡æ¯ä¸­çš„æ¯ä¸€æ­¥(Step)ï¼ŒDockeréƒ½åœ¨åˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒã€‚åŒæ—¶å®ƒè¿˜æ‰“å°äº†é•œåƒIDï¼š <code>---&gt; 92cd04f91315</code>ã€‚è¿™æ ·çš„å¥½å¤„åœ¨äºï¼Œæˆ‘ä»¬ä¿®æ”¹<code>Dockerfile</code>åé‡æ–°æ„å»ºé•œåƒæ—¶ï¼Œé‚£äº›æ²¡æœ‰è¢«ä¿®æ”¹çš„éƒ¨åˆ†å¯ä»¥å°†ä¸Šæ¬¡æ„å»ºçš„é•œåƒå½“ä½œç¼“å­˜ï¼ŒåŠ å¿«æ„å»ºçš„é€Ÿåº¦ã€‚</p><p>ä½†æ˜¯è¿™ä¹Ÿä¼šæœ‰äº›å°é—®é¢˜ï¼ŒDockeræ˜¯æ ¹æ®<code>Dockerfile</code>æ¥åˆ¤æ–­æ„å»ºæ—¶çš„å˜åŒ–çš„ã€‚ä½†å¦‚æœéœ€è¦æ‰§è¡Œæ›´æ–°è½¯ä»¶ç­‰æ“ä½œï¼Œè€Œ<code>Dockerfile</code>å†…çš„å‘½ä»¤æ˜¯æ²¡æœ‰å˜åŒ–æ—¶ï¼ŒDockerä¼šç»§ç»­ä½¿ç”¨ä»¥å‰çš„ç¼“å­˜ï¼Œå¯¼è‡´æ—§çš„è½¯ä»¶è¿˜æ˜¯è¢«å®‰è£…äº†ã€‚</p><p>æ‰€æœ‰åœ¨æ‰§è¡ŒæŸäº›å¿…è¦çš„æ“ä½œæ—¶ï¼Œä¸ä½¿ç”¨ç¼“å­˜ä¹Ÿæ˜¯ææœ‰å¥½å¤„çš„ã€‚åœ¨æ„å»ºé•œåƒæ—¶ï¼Œ<strong>ä½¿ç”¨<code>--no-cache=True</code>å³å¯</strong>ã€‚</p><p><code>RUN</code>å‘½ä»¤æ¨èä½¿ç”¨ä¸€æ¡å‘½ä»¤å®Œæˆå°½å¯èƒ½å¤šçš„æ“ä½œï¼Œ<code>Dockerfile</code>ä¸­çš„æ¯ä¸ªå‘½ä»¤éƒ½ä¼šè¢«åˆ†ä¸ºæ„å»ºé•œåƒçš„ä¸€æ­¥æ¥æ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ„å»ºæ—¶çš„æ­¥æ•°(Step)ã€‚Docker é•œåƒç±»ä¼¼äºæ´‹è‘±ã€‚å®ƒä»¬éƒ½æœ‰å¾ˆå¤šå±‚ã€‚ä¸ºäº†ä¿®æ”¹å†…å±‚ï¼Œåˆ™éœ€è¦å°†å¤–é¢çš„å±‚éƒ½åˆ æ‰ã€‚</p><h3 id="ç¬¬ä¸€æ¬¡çš„è¿è¡Œ"><a href="#ç¬¬ä¸€æ¬¡çš„è¿è¡Œ" class="headerlink" title="ç¬¬ä¸€æ¬¡çš„è¿è¡Œ"></a>ç¬¬ä¸€æ¬¡çš„è¿è¡Œ</h3><p>å°†æ‰€æœ‰çš„è½¯ä»¶éƒ½å®‰è£…ã€æµ‹è¯•å®Œåï¼Œå°±å¯ä»¥æ„å»ºèƒ½å¤Ÿç¬¬ä¸€æ¬¡è¿è¡Œçš„é•œåƒäº†ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œè¿˜éœ€è¦é…ç½®éœ€è¦è¿è¡Œçš„è½¯ä»¶ï¼Œä¾‹å¦‚ä½¿ç”¨hexoç”Ÿæˆé™æ€æ–‡ä»¶ï¼Œå¯åŠ¨apacheç­‰ã€‚</p><pre><code class="hljs dockerfile"><span class="hljs-keyword">COPY</span><span class="bash"> DefectingCat.github.io /data/DefectingCat.github.io</span>
<span class="hljs-keyword">WORKDIR</span><span class="bash"> /data/DefectingCat.github.io</span>
<span class="hljs-keyword">RUN</span><span class="bash"> hexo g \</span>
<span class="bash">        &amp;&amp; cp -a public/* /var/www/localhost/htdocs</span>

<span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">80</span> <span class="hljs-number">443</span>
<span class="hljs-keyword">CMD</span><span class="bash"> [<span class="hljs-string">&quot;/usr/sbin/httpd&quot;</span>,<span class="hljs-string">&quot;-f&quot;</span>,<span class="hljs-string">&quot;/etc/apache2/httpd.conf&quot;</span>,<span class="hljs-string">&quot;-DFOREGROUND&quot;</span>]</span></code></pre><ul><li><code>COPY</code>å°†å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶å¤åˆ¶è¿›å®¹å™¨å†…çš„ç›®å½•ã€‚åœ¨å®‰è£…è½¯ä»¶æ—¶å°±å·²ç»ä½¿ç”¨<code>RUN</code>æ¥åˆ›å»ºè¿‡éœ€è¦çš„ç›®å½•äº†ã€‚</li><li><code>WORKDIR</code>åˆ‡æ¢å·¥ä½œçš„ç›®å½•ï¼Œå’Œ<code>cd</code>ç±»ä¼¼ï¼›åˆ‡æ¢å<code>RUN</code>ç­‰å‘½ä»¤éƒ½ä¼šåœ¨å½“å‰ç›®å½•ä¸‹å·¥ä½œã€‚</li><li><code>EXPOSE</code>æš´éœ²éœ€è¦ä½¿ç”¨åˆ°çš„ç«¯å£ã€‚</li><li><code>CMD</code>å’Œ<code>RUN</code>ç±»ä¼¼ï¼Œé€šå¸¸ç”¨äºæ¥å¯åŠ¨å®¹å™¨æœåŠ¡ã€‚</li></ul><p>å…³äº<code>CMD</code>ï¼š</p><p><code>CMD</code>åªèƒ½å­˜åœ¨ä¸€æ¡ï¼Œæ ¹æ®è¿è¡Œçš„è½¯ä»¶ï¼Œå®ƒå°†å æ®æœ€åå®¹å™¨è¾“å‡ºçš„ç»ˆç«¯ã€‚å› ä¸ºå®¹å™¨å¹¶ä¸åƒè™šæ‹ŸåŒ–æˆ–è€…ç‰©ç†æœºé‚£æ ·ï¼Œå¯ä»¥ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹ï¼›å®¹å™¨æœ¬èº«å°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œå®¹å™¨å†…æ²¡æœ‰åå°æœåŠ¡çš„æ¦‚å¿µã€‚æ­£ç¡®çš„åšæ³•æ˜¯ä½¿ç”¨<code>CMD</code>ç›´æ¥æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶ä¸”è¦æ±‚ä»¥å‰å°å½¢å¼è¿è¡Œã€‚</p><p>å½“å‰çš„æ“ä½œå¾ˆç®€å•ï¼Œå°±æ˜¯å¤åˆ¶å®¿ä¸»æœºä¸Šgitå…‹éš†ä¸‹æ¥çš„æ–‡ä»¶åˆ°å®¹å™¨çš„åˆ¶å®šæ–‡ä»¶å¤¹ï¼Œç„¶åä½¿ç”¨<code>hexo</code>æ¥ç”Ÿæˆé™æ€æ–‡ä»¶ï¼Œæœ€åå¤åˆ¶åˆ°<code>apache</code>çš„å·¥ä½œç›®å½•ä¸‹ã€‚</p><p>åˆ°è¿™é‡Œå°±å¯ä»¥æ¥è¿è¡Œä¸€ä¸ªä¸€æ¬¡æ€§çš„å®¹å™¨æµ‹è¯•ä¸€ä¸‹æˆ‘ä»¬çš„æœåŠ¡æ˜¯å¦è¿è¡Œæ­£å¸¸äº†ã€‚å¦‚æœä¸Šè¿°éƒ½æ²¡æœ‰ä»»ä½•é—®é¢˜çš„è¯ï¼Œç°åœ¨æ‰“å¼€æµè§ˆå™¨å°±åº”è¯¥èƒ½çœ‹åˆ°hexoçš„blogäº†ğŸ‰ã€‚</p><pre><code class="hljs bash">docker run -p 80:80 --rm blog</code></pre><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒDockerfileåº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> alpine:latest
<span class="hljs-keyword">MAINTAINER</span> Defectink &lt;i@defect.ink&gt;

<span class="hljs-comment">#install</span>
<span class="hljs-keyword">RUN</span><span class="bash"> apk update \</span>
<span class="bash">        &amp;&amp; apk upgrade \</span>
<span class="bash">        &amp;&amp; apk add --no-cache \</span>
<span class="bash">        apache2 \</span>
<span class="bash">        nodejs \</span>
<span class="bash">        npm \</span>
<span class="bash">        tzdata \</span>
<span class="bash">        &amp;&amp; cp -r -f /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span>
<span class="bash">        &amp;&amp; rm -rf /var/cache/apk/* \</span>
<span class="bash">        &amp;&amp; mkdir -p /data/DefectingCat.github.io \</span>
<span class="bash">        &amp;&amp; npm config <span class="hljs-built_in">set</span> unsafe-perm <span class="hljs-literal">true</span> \</span>
<span class="bash">        &amp;&amp; npm install -g hexo</span>

<span class="hljs-keyword">COPY</span><span class="bash"> DefectingCat.github.io /data/DefectingCat.github.io</span>
<span class="hljs-keyword">WORKDIR</span><span class="bash"> /data/DefectingCat.github.io</span>
<span class="hljs-keyword">RUN</span><span class="bash"> hexo g \</span>
<span class="bash">        &amp;&amp; cp -a public/* /var/www/localhost/htdocs</span>

<span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">80</span> <span class="hljs-number">443</span>
<span class="hljs-keyword">CMD</span><span class="bash"> [<span class="hljs-string">&quot;/usr/sbin/httpd&quot;</span>,<span class="hljs-string">&quot;-f&quot;</span>,<span class="hljs-string">&quot;/etc/apache2/httpd.conf&quot;</span>,<span class="hljs-string">&quot;-DFOREGROUND&quot;</span>]</span></code></pre><p>å®‰è£…äº†ä¸€äº›å¿…è¦çš„è½¯ä»¶ï¼ŒåŒæ—¶ä¹Ÿå°½é‡çš„å‡å°‘äº†é•œåƒæ„å»ºåçš„å¤§å°ã€‚</p><h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><p>ç°ä»£çš„ç½‘ç«™åº”è¯¥éƒ½ä¸ä¼šå°‘çš„äº†SSLï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è§çš„httpsã€‚ç›®å‰è‡ªå·±çš„ç½‘ç«™ç”¨çš„æ˜¯æœ€ç®€å•çš„LetsEncryptï¼Œä½¿ç”¨ä»–å®¶çš„å·¥å…·Certbotæ¥ç”³è¯·è¯ä¹¦åŠå…¶æ–¹ä¾¿ã€‚åœ¨å®¿ä¸»æœºçš„ç¯å¢ƒä¸‹ç”šè‡³è¿˜èƒ½è‡ªåŠ¨é…ç½®ã€‚ä½†æ˜¯ç›®å‰ç”¨çš„æ˜¯Dockerç¯å¢ƒï¼Œåœ¨ä½¿ç”¨Dockefileæ„å»ºæ—¶ï¼Œæ˜¯æ²¡æœ‰äº¤äº’ç¯å¢ƒçš„ã€‚è‡ªåŠ¨é…ç½®ä¹Ÿå¯èƒ½æ— æ³•ç”Ÿæ•ˆã€‚</p><h3 id="ç”Ÿæˆè¯ä¹¦"><a href="#ç”Ÿæˆè¯ä¹¦" class="headerlink" title="ç”Ÿæˆè¯ä¹¦"></a>ç”Ÿæˆè¯ä¹¦</h3><p>Certbotç”Ÿæˆè¯ä¹¦å¾ˆæ˜¯æ–¹ä¾¿ï¼Œåœ¨Dockerç¯å¢ƒä¸‹ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ä½¿ç”¨å®˜æ–¹çš„é•œåƒå¯ä»¥å¾ˆæ–¹ä¾¿çš„ç”Ÿæˆï¼š</p><pre><code class="hljs bash">sudo docker run -it --rm --name certbot \
            -v <span class="hljs-string">&quot;/etc/letsencrypt:/etc/letsencrypt&quot;</span> \
            -v <span class="hljs-string">&quot;/var/lib/letsencrypt:/var/lib/letsencrypt&quot;</span> \
            certbot/certbot certonly</code></pre><p>é…åˆ<code>certonly</code>åªè·å–è¯ä¹¦ï¼Œå¹¶<code>-v</code>æ¥å°†å®¹å™¨çš„ç›®å½•æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œè¿™æ ·å°±èƒ½åœ¨ç”ŸæˆåæŠŠè¯ä¹¦å­˜åˆ°å®¿ä¸»æœºç›®å½•äº†ã€‚</p><p>ç”Ÿæˆæ—¶ï¼Œä¹Ÿä¼šæœ‰ä¸¤ç§å·¥ä½œæ¨¡å¼é€‰æ‹©ï¼š</p><pre><code class="hljs bash">How would you like to authenticate with the ACME CA?
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
1: Spin up a temporary webserver (standalone)
2: Place files <span class="hljs-keyword">in</span> webroot directory (webroot)
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Select the appropriate number [1-2] <span class="hljs-keyword">then</span> [enter] (press <span class="hljs-string">&#x27;c&#x27;</span> to cancel):</code></pre><p>åˆ†åˆ«æ˜¯ï¼š</p><ul><li>standaloneæ¨¡å¼ï¼šå¯åŠ¨ä¸€ä¸ªä¸´æ—¶çš„webserverï¼›</li><li>webrootæ¨¡å¼ï¼šå°†éªŒè¯æ–‡ä»¶æ”¾åˆ°å½“å‰å·²æœ‰çš„webserverç›®å½•ä¸‹ï¼›</li></ul><p>å¦‚æœå½“å‰æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„webserverï¼Œä½¿ç”¨standaloneæ¨¡å¼æ˜¯æœ€ä¸ºæ–¹ä¾¿çš„ã€‚Certbotå°†è‡ªå·±è¿è¡Œä¸€ä¸ªä¸´æ—¶çš„webserverå®Œæˆè®¤è¯ã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨standaloneæ¨¡å¼ï¼Œåœ¨è¿è¡Œéœ€è¦æ·»åŠ ä¸€ä¸ªæ˜ å°„çš„ç«¯å£ï¼š</p><pre><code class="hljs bash">sudo docker run -it -p 80:80 --rm --name certbot \
            -v <span class="hljs-string">&quot;/data/docker/apache/letsencrypt:/etc/letsencrypt&quot;</span> \
            -v <span class="hljs-string">&quot;/var/lib/letsencrypt:/var/lib/letsencrypt&quot;</span> \
            certbot/certbot certonly</code></pre><p>å› ä¸ºCertbotå¯ç”¨äº†ä¸€ä¸ªä¸´æ—¶çš„webserveræ¥éªŒè¯åŸŸåè§£æï¼Œå¦‚æœä¸æŠŠå®¹å™¨çš„<code>80</code>ç«¯å£æ˜ å°„å‡ºæ¥çš„è¯ï¼Œå°†æ— æ³•å®ŒæˆéªŒè¯ã€‚</p><p>åœ¨ä¸€åˆ‡éƒ½æ²¡æœ‰ä»»ä½•é—®é¢˜ä¹‹åï¼Œå°±èƒ½çœ‹åˆ°Congratulationsäº†ï¼š</p><pre><code class="hljs bash">IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/domain/fullchain.pem</code></pre><p>æ ¹æ®å®˜ç½‘çš„è¯´æ³•ï¼Œè¯ä¹¦å‡é“¾æ¥åœ¨<code>/etc/letsencrypt/live</code>ç›®å½•å†…ã€‚</p><blockquote><p><code>/etc/letsencrypt/archive</code> and <code>/etc/letsencrypt/keys</code> contain all previous keys and certificates, while <code>/etc/letsencrypt/live</code> symlinks to the latest versions.</p></blockquote><h3 id="Mod-ssl"><a href="#Mod-ssl" class="headerlink" title="Mod_ssl"></a>Mod_ssl</h3><p>æœ‰äº†è¯ä¹¦ä¹‹åï¼Œapacheè¿˜éœ€è¦sslçš„modã€‚alpineçš„é•œåƒå®‰è£…apacheæ—¶æ˜¯æ²¡æœ‰å®‰è£…çš„sslçš„modã€‚æ‰€ä»¥è¿˜éœ€è¦åœ¨Dockerfileå†…æ·»åŠ ä¸€è¡Œï¼Œæ‰‹åŠ¨è¿›è¡Œå®‰è£…ï¼ŒåŒ…åä¸º<code>apache2-ssl</code>ï¼š</p><pre><code class="hljs dockerfile"><span class="hljs-keyword">RUN</span><span class="bash"> apk update \</span>
<span class="bash">        &amp;&amp; apk upgrade \</span>
<span class="bash">        &amp;&amp; apk add --no-cache \</span>
<span class="bash">        apache2 \</span>
<span class="bash">        apache2-ssl \</span></code></pre><p>åœ¨é‡æ–°æ„å»ºä¹‹å‰ï¼Œè¿˜éœ€è¦ä¿®æ”¹apacheçš„<code>ssl.conf</code>ã€‚å¦‚ä½•å–å¾—<code>ssl.conf</code>å‘¢ï¼Ÿæˆ‘ä»¬åªéœ€è¦æ„å»ºä¸€ä¸ªä¸´æ—¶çš„alpineé•œåƒï¼Œåœ¨å®¹å™¨å†…ä½¿ç”¨ç›¸åŒçš„å‘½ä»¤å®‰è£…ä¸€ä¸ªapacheä¸ssl modï¼Œä¹‹ååœ¨<code>/etc/apache2/conf.d</code>ç›®å½•å†…å°±æœ‰<code>ssl.conf</code>é…ç½®æ–‡ä»¶äº†ã€‚å°†å…¶copyåˆ°å®¿ä¸»æœºå†…ä¿®æ”¹å°±å¥½äº†ã€‚</p><pre><code class="hljs bash">apk add apache2-ssl</code></pre><p>åœ¨å¯åŠ¨å‘½ä»¤å†…çš„<code>httpd.conf</code>é…ç½®æ–‡ä»¶ä¼šåŒ…å«<code>ssl.conf</code>ã€‚æ‰€ä»¥åªéœ€è¦ä¿®æ”¹<code>ssl.conf</code>ï¼Œå†åœ¨æ„å»ºæ—¶å°†å…¶copyåˆ°é•œåƒå†…å°±å¥½äº†ã€‚</p><p><code>httpd.conf</code>å†…çš„å·²æœ‰é…ç½®ï¼š</p><pre><code class="hljs awk">IncludeOptional <span class="hljs-regexp">/etc/</span>apache2<span class="hljs-regexp">/conf.d/</span>*.conf</code></pre><p>é‚£ä¹ˆï¼Œå¦‚ä½•ä¼˜é›…çš„å°†å®¹å™¨å†…çš„<code>ssl.conf</code>copyå‡ºæ¥å‘¢ï¼Ÿ</p><p>å¯ä»¥åœ¨å…ˆå°†å®¹å™¨æ”¾åœ¨åå°è¿è¡Œï¼š</p><pre><code class="hljs bash">docker run -id <span class="hljs-built_in">test</span></code></pre><p>ç„¶åä½¿ç”¨dockerè‡ªå¸¦çš„<code>docker cp</code>å‘½ä»¤æ¥copyåˆ°å®¿ä¸»æœºçš„ç›®å½•ï¼š</p><pre><code class="hljs bash">docker cp 253d3ca34521:/etc/apache2/conf.d/ssl.conf /root</code></pre><p>å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥æ‰“å¼€ï¼Œç„¶åè®°å½•æ–‡ä»¶å†…å®¹å†å¤åˆ¶å‡ºæ¥ã€‚</p><p>æœ‰äº†Mod_sslç»„ä»¶ä¹‹åï¼Œå°±å¯ä»¥é…åˆSSLè¯ä¹¦æ¥å¯¹ç½‘ç«™è¿›è¡ŒåŠ å¯†äº†ã€‚æ—¢ç„¶èƒ½å°†é»˜è®¤çš„<code>ssl.conf</code>å¤åˆ¶å‡ºæ¥ï¼Œå°±å¯ä»¥å¯¹å…¶ä¿®æ”¹ç„¶ååœ¨ç”Ÿæˆé•œåƒæ—¶å†å¤åˆ¶ä¼šå®¹å™¨å†…çš„åŸç›®å½•ã€‚</p><p>å‰©ä¸‹å¯¹äºSSLçš„é…ç½®å°±å’Œç»™å®¿ä¸»æœºé…ç½®åŠ å¯†ä¸€æ ·äº†ï¼Œå‡ ä¹æ²¡æœ‰ä»€ä¹ˆä¸åŒã€‚ä¸»è¦å°±æ˜¯åœ¨<code>ssl.conf</code>ä¸­å¡«ä¸Šæ­£ç¡®çš„è¯ä¹¦ç›®å½•ï¼š</p><pre><code class="hljs awk">SSLCertificateFile <span class="hljs-regexp">/etc/</span>letsencrypt<span class="hljs-regexp">/live/</span>defect.ink/fullchain.pem
<span class="hljs-comment">#SSLCertificateFile /etc/ssl/apache2/server-dsa.pem</span>
<span class="hljs-comment">#SSLCertificateFile /etc/ssl/apache2/server-ecc.pem</span>

<span class="hljs-comment">#   Server Private Key:</span>
<span class="hljs-comment">#   If the key is not combined with the certificate, use this</span>
<span class="hljs-comment">#   directive to point at the key file.  Keep in mind that if</span>
<span class="hljs-comment">#   you&#x27;ve both a RSA and a DSA private key you can configure</span>
<span class="hljs-comment">#   both in parallel (to also allow the use of DSA ciphers, etc.)</span>
<span class="hljs-comment">#   ECC keys, when in use, can also be configured in parallel</span>
SSLCertificateKeyFile <span class="hljs-regexp">/etc/</span>letsencrypt<span class="hljs-regexp">/live/</span>defect.ink/privkey.pem</code></pre><p>Letâ€™s Encryptç”Ÿæˆçš„è¯ä¹¦åœ¨è·¯å¾„ä¸‹è¿˜ä¼šæœ‰ä¸ª<code>fullchain.pem</code>ï¼Œè¿™æ˜¯ä¸€æ•´ä¸ªè¯ä¹¦é“¾ã€‚åœ¨é…ç½®æ–‡ä»¶ä¸­åªéœ€è¦è¿™ä¸ªè¯ä¹¦å’Œä¸€ä¸ªç§é’¥<code>privkey.pem</code>å°±å¥½ã€‚</p><h3 id="è·³è½¬è‡³443"><a href="#è·³è½¬è‡³443" class="headerlink" title="è·³è½¬è‡³443"></a>è·³è½¬è‡³443</h3><p>åœ¨æœ‰äº†httpsä¹‹åï¼Œå¦‚æœä¸éœ€è¦80ç«¯å£è¿˜èƒ½ç»§ç»­è®¿é—®ã€‚å¯ä»¥ä½¿ç”¨301è·³è½¬æ¥å°†è®¿é—®80ç«¯å£çš„è®¿å®¢éƒ½è·³è½¬åˆ°443ã€‚Apacheçš„mod_rewriteå¯ä»¥è½»æ¾çš„å®ç°é’ˆå¯¹å„ç§æ¡ä»¶çš„è·³è½¬ã€‚</p><p>mod_rewriteçš„ä½œç”¨å¾ˆå¤šï¼Œèƒ½è®¾ç½®çš„æ¡ä»¶ä¹Ÿå¯ä»¥å¾ˆå¤æ‚ã€‚å½“ç„¶é…ç½®ä¸ªç®€å•çš„è·³è½¬ä¸æ˜¯éå¸¸çš„å¤æ‚ã€‚</p><pre><code class="hljs apache"><span class="hljs-attribute"><span class="hljs-nomarkup">RewriteEngine</span></span> <span class="hljs-literal">on</span>
<span class="hljs-attribute"><span class="hljs-nomarkup">RewriteCond</span></span> <span class="hljs-variable">%&#123;SERVER_NAME&#125;</span> =defect.ink
<span class="hljs-attribute"><span class="hljs-nomarkup">RewriteRule</span></span> ^ https://<span class="hljs-variable">%&#123;SERVER_NAME&#125;</span><span class="hljs-variable">%&#123;REQUEST_URI&#125;</span><span class="hljs-meta"> [END,NE,R=permanent]</span></code></pre><ul><li><code>RewriteEngine</code>æ‰“å¼€è·³è½¬å¼•æ“ï¼›</li><li><code>RewriteCond</code>è·³è½¬çš„æ¡ä»¶ï¼›è¿™é‡Œè®¾ç½®å½“åŸŸåä¸º<code>defect.ink</code>æ—¶ï¼Œæ‰§è¡Œä¸‹é¢çš„è·³è½¬åŠ¨ä½œï¼›</li><li><code>RewriteRule</code>è·³è½¬çš„åŠ¨ä½œï¼›å½“ç¬¦åˆä¸Šé¢çš„æ¡ä»¶æ—¶ï¼Œæ‰§è¡Œæ·»åŠ https<code>https://%&#123;SERVER_NAME&#125;%&#123;REQUEST_URI&#125;</code>ã€‚è€Œåé¢çš„å˜é‡ä¿æŒä¸åŠ¨ã€‚</li></ul><p>è¿™è¡Œé…ç½®æ˜¯æ¥è‡ªäºcertbotçš„è‡ªåŠ¨é…ç½®ä¸­çš„ï¼Œåœ¨é…ç½®å®¿ä¸»æœºçš„sslæ—¶å¯ä»¥é€‰æ‹©å…¨éƒ¨è·³è½¬ã€‚ç„¶åå®ƒå°±ä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨é…ç½®äº†ã€‚å¯¹å…¶è¿›è¡Œç®€å•çš„ä¿®æ”¹å°±å¯ä»¥ä½œç”¨ä¸å…¶ä»–çš„é…ç½®æ–‡ä»¶äº†ã€‚</p><p>è¿™å‡ è¡Œæ¨èæ˜¯å†™åœ¨<code>httpd.conf</code>çš„æœ«å°¾ï¼Œä¹Ÿå°±æ˜¯<code>IncludeOptional /etc/apache2/conf.d/*.conf</code>çš„ä¸Šæ–¹ã€‚è™½ç„¶ssl.confä¹Ÿä¼šè¢«includeè¿›æ¥ï¼Œä½†æ˜¯è¿˜æ˜¯æ„Ÿè§‰å†™åœ¨è¿™é‡Œè¦æ–¹ä¾¿ä¸€ç‚¹ã€‚</p><p>ç„¶åå°†<code>httpd.conf</code>å’Œ<code>ssl.conf</code>ä¸€æ ·åœ¨æ„å»ºæ—¶å¤åˆ¶åˆ°å®¹å™¨å†…å°±okäº†ã€‚</p><pre><code class="hljs dockerfile">&amp;&amp; cp -a ssl.conf /etc/apache2/conf.d/ \
&amp;&amp; cp -a httpd.conf /etc/apache2/</code></pre><h3 id="Renew"><a href="#Renew" class="headerlink" title="Renew"></a>Renew</h3><p>Letâ€™s Encryptçš„è¯ä¹¦è™½ç„¶å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯ä¸€æ¬¡åªèƒ½ç”Ÿæˆä¸‰ä¸ªæœˆæœ‰æ•ˆæœŸçš„è¯ä¹¦ã€‚ä½¿ç”¨å’Œç”Ÿæˆå·®ä¸å¤šçš„æ–¹æ³•renewè¯ä¹¦å°±å¥½äº†ã€‚</p><pre><code class="hljs livescript">sudo docker run -<span class="hljs-literal">it</span> -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> --rm --name certbot <span class="hljs-string">\</span>
             -v <span class="hljs-string">&quot;/data/docker/apache/letsencrypt:/etc/letsencrypt&quot;</span> <span class="hljs-string">\</span>
             -v <span class="hljs-string">&quot;/var/lib/letsencrypt:/var/lib/letsencrypt&quot;</span> <span class="hljs-string">\</span>
             certbot/certbot renew</code></pre><p>æƒ³è¦è‡ªåŠ¨åŒ–æ‰§è¡Œè¯ï¼Œå¯ä»¥ä½¿ç”¨crontabæ¥å®šæ—¶è¿è¡Œã€‚</p><h2 id="å…¨éƒ¨çš„Dockerfile"><a href="#å…¨éƒ¨çš„Dockerfile" class="headerlink" title="å…¨éƒ¨çš„Dockerfile"></a>å…¨éƒ¨çš„Dockerfile</h2><p>è¿™æ—¶å€™çš„é…ç½®æ–‡ä»¶çœ‹èµ·æ¥åº”è¯¥æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š</p><pre><code class="hljs dockerfile"><span class="hljs-comment">#test</span>
  
<span class="hljs-keyword">FROM</span> alpine:latest
<span class="hljs-keyword">MAINTAINER</span> Defectink &lt;i@defect.ink&gt;

<span class="hljs-comment">#install</span>
<span class="hljs-keyword">RUN</span><span class="bash"> apk update \</span>
<span class="bash">        &amp;&amp; apk upgrade \</span>
<span class="bash">        &amp;&amp; apk add --no-cache \</span>
<span class="bash">        apache2 \</span>
<span class="bash">        apache2-ssl \</span>
<span class="bash">        nodejs \</span>
<span class="bash">        npm \</span>
<span class="bash">        tzdata \</span>
<span class="bash">        &amp;&amp; cp -r -f /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span>
<span class="bash">        &amp;&amp; rm -rf /var/cache/apk/* \</span>
<span class="bash">        &amp;&amp; mkdir -p /data/DefectingCat.github.io \</span>
<span class="bash">        &amp;&amp; npm config <span class="hljs-built_in">set</span> unsafe-perm <span class="hljs-literal">true</span> \</span>
<span class="bash">        &amp;&amp; npm install -g hexo</span>

<span class="hljs-keyword">COPY</span><span class="bash"> DefectingCat.github.io /data/DefectingCat.github.io</span>
<span class="hljs-keyword">WORKDIR</span><span class="bash"> /data/DefectingCat.github.io</span>
<span class="hljs-keyword">RUN</span><span class="bash"> hexo g \</span>
<span class="bash">        &amp;&amp; cp -a public/* /var/www/localhost/htdocs/ \</span>
<span class="bash">        &amp;&amp; cp -a ssl.conf /etc/apache2/conf.d/ \</span>
<span class="bash">        &amp;&amp; cp -a httpd.conf /etc/apache2/</span>

<span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">80</span> <span class="hljs-number">443</span>
<span class="hljs-keyword">CMD</span><span class="bash"> [<span class="hljs-string">&quot;/usr/sbin/httpd&quot;</span>,<span class="hljs-string">&quot;-f&quot;</span>,<span class="hljs-string">&quot;/etc/apache2/httpd.conf&quot;</span>,<span class="hljs-string">&quot;-DFOREGROUND&quot;</span>]</span></code></pre><h2 id="å¯åŠ¨ï¼"><a href="#å¯åŠ¨ï¼" class="headerlink" title="å¯åŠ¨ï¼"></a>å¯åŠ¨ï¼</h2><pre><code class="hljs bash">docker run -id --name=<span class="hljs-string">&quot;blog&quot;</span> -v /etc/letsencrypt/:/etc/letsencrypt/ -p 80:80 -p 443:443 blog</code></pre><p>å…¨éƒ¨æ“ä½œå®Œäº†ï¼Œå¯åŠ¨å‘½ä»¤ä¹Ÿéšç€æ“ä½œå˜å¾—æ›´åŠ çš„å¤æ‚äº†ã€‚</p><ul><li><code>-id</code>æ‰”åˆ°åå°ï¼›</li><li><code>--name</code>å®¹å™¨åˆ«åï¼›</li><li><code>-v</code>æ˜ å°„ä¹‹å‰çš„sslè¯ä¹¦çš„ç›®å½•ï¼›</li><li><code>-p</code>80å’Œ443éƒ½éœ€è¦æ˜ å°„ï¼›</li></ul><h2 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h2><p>ä¸€äº›æ¯”è¾ƒæ–¹ä¾¿çš„å‘½ä»¤ã€‚</p><p>åˆ é™¤æ‰€æœ‰<code>&lt;none&gt;</code>çš„é•œåƒï¼š</p><pre><code class="hljs bash">docker rmi $(docker images -f <span class="hljs-string">&quot;dangling=true&quot;</span> -q)</code></pre><p>åœæ­¢æ‰€æœ‰å®¹å™¨ï¼Œåˆ é™¤æ‰€æœ‰å®¹å™¨ï¼š</p><pre><code class="hljs bash">docker <span class="hljs-built_in">kill</span> $(docker ps -q) ; docker rm $(docker ps -a -q)</code></pre><p>åœæ­¢æ‰€æœ‰å®¹å™¨ï¼Œåˆ é™¤æ‰€æœ‰å®¹å™¨ï¼Œ<strong>åˆ é™¤æ‰€æœ‰é•œåƒ</strong>ï¼š</p><pre><code class="hljs bash">docker <span class="hljs-built_in">kill</span> $(docker ps -q) ; docker rm $(docker ps -a -q) ; docker rmi $(docker images -q -a)</code></pre><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><p><a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-create-an-ssl-certificate-on-apache-for-centos-7">How To Create an SSL Certificate on Apache for CentOS 7</a></p></li><li><p><a target="_blank" rel="noopener" href="https://pkgs.alpinelinux.org/package/edge/main/x86/apache2-ssl">apache2-ssl</a></p></li><li><p><a target="_blank" rel="noopener" href="https://certbot.eff.org/docs/install.html#running-with-docker">Certbot running with Docker</a></p></li><li><p><a target="_blank" rel="noopener" href="https://certbot.eff.org/docs/using.html#where-certs">Where my Certificate</a></p></li></ul></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E5%AE%9E%E8%B7%B5/">å®è·µ</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/Linux/">Linux</a></div></div><p class="note note-warning"><a target="_blank" href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" rel="nofollow noopener noopener">CC BY-SA 3.0â¤</a></p><div class="post-prevnext row"><article class="post-prev col-6"><a href="/defect/header-practice-have-to-win-this-a.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Headerå®è·µ-å¾—æ‹¿ä¸‹è¿™ä¸ªA</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></article><article class="post-next col-6"><a href="/defect/modify-icloud-storage-location-on-windows.html"><span class="hidden-mobile">ä¿®æ”¹Windowsç«¯iCloudäº‘ç›˜å­˜å‚¨ä½ç½®</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span><i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><div id="vcomments"></div><script type="text/javascript">function loadValine(){addScript("https://cdn.defectink.com/static/valine/1.4.14/Valine.min.js",function(){new Valine({el:"#vcomments",app_id:"dD9t7mcIBVzJWag5ez6GPy2v-MdYXbMMI",app_key:"bWG6pmKsEscrH4JjrpNNAAy6",placeholder:"å˜¤å˜¤å˜¤ï¼Ÿï¼Ÿï¼Ÿ",path:window.location.pathname,avatar:"retro",meta:["nick","mail","link"],pageSize:"10",lang:"zh-CN",highlight:!0,recordIP:!1,serverURLs:""})})}waitElementVisible("vcomments",loadValine)</script><noscript>Please enable JavaScript to view the <a target="_blank" href="https://valine.js.org" rel="nofollow noopener noopener">comments powered by Valine.</a></noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div id="tocbot"></div></div></div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a><i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="beian"><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">çš–ICPå¤‡17017808å·</a></div></footer><script src="https://cdn.defectink.com/static/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.defectink.com/static/twitter-bootstrap/4.5.3/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script defer="defer" src="https://cdn.defectink.com/static/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script src="/js/xfy.js"></script><script src="https://cdn.defectink.com/static/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready(function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:"#post-body",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:3,scrollSmooth:!0,headingsOffset:-t}),0<$(".toc-list-item").length&&$("#toc").css("visibility","visible")})</script><script src="https://cdn.defectink.com/static/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","Docker-æ„å»ºå±äºè‡ªå·±çš„é•œåƒ&nbsp;"],cursorChar:"â¤",typeSpeed:70,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="/js/local-search.js"></script><script>var path="/xml/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.defectink.com/static/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.defectink.com/static/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})</script><script src="https://cdn.defectink.com/static/mermaid/8.5.0/mermaid.min.js"></script><script>window.mermaid&&mermaid.initialize({theme:"default"})</script></body></html>