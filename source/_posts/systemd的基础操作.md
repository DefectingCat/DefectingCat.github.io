<<<<<<< HEAD
---
title: systemd çš„åŸºç¡€æ“ä½œ
date: 2019-06-14 14:42:41
tags: Linux
categories: Linux
url: basic-knowledge-of-systemd
index_img: /images/systemdçš„åŸºç¡€æ“ä½œ/logo.webp
---

## ä»€ä¹ˆæ˜¯systemdï¼Ÿ

Systemdæ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ä¸€äº›Linuxå‘è¡Œç‰ˆä¸­å¸¸è§çš„ä¸€å¥—ä¸­å¤®åŒ–ç³»ç»ŸåŠè®¾ç½®ç®¡ç†ç¨‹åº(init)ï¼ŒåŒ…æ‹¬æœ‰[å®ˆæŠ¤è¿›ç¨‹](https://zh.wikipedia.org/wiki/%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B)ã€[ç¨‹åºåº“](https://zh.wikipedia.org/wiki/%E7%A8%8B%E5%BC%8F%E5%BA%AB)ä»¥åŠåº”ç”¨è½¯ä»¶ã€‚

æˆ‘ä»¬ç»å¸¸ä½¿ç”¨`systemctl start apache2`æ¥å¯åŠ¨ä¸€äº›æœåŠ¡æˆ–è€…åº”ç”¨è½¯ä»¶æ—¶ï¼Œä½¿ç”¨åˆ°çš„å°±æ˜¯Systemdçš„ä¸€éƒ¨åˆ†ã€‚

å½“å‰ç»å¤§å¤šæ•°çš„Linuxå‘è¡Œç‰ˆéƒ½å·²é‡‡ç”¨systemdä»£æ›¿åŸæ¥çš„[System V](https://zh.wikipedia.org/wiki/UNIX_System_V)ã€‚

## å­¦ä¹ å®ƒçš„ä½œç”¨ï¼Ÿ

å®ƒèƒ½å¤Ÿæ–¹ä¾¿çš„å¯¹ä¸€äº›è½¯ä»¶è¿è¡Œè¿›è¡Œç®¡ç†ï¼Œç»å¸¸ä½¿ç”¨`systemctl`çš„åŒå­¦ä»¬å¯èƒ½ä¼šæ¯”è¾ƒäº†è§£ï¼Œè­¬å¦‚æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ï¼Œè®¾ç½®å¼€æœºè‡ªå¯ç­‰æ“ä½œã€‚

æœ€è¿‘å°é²œäº†Ubuntuï¼Œä½†æ˜¯é‡åˆ°ä¸ªæ–°çš„é—®é¢˜ã€‚åœ¨Ubuntu 18.10ä¸­ï¼Œå·²ç»å°†ä»¥å‰çš„å¼€æœºè‡ªå¯åŠ¨çš„è„šæœ¬`/etc/rc.local`å»æ‰äº†ã€‚æ— æ„ä¸­çœ‹åˆ°ä½¿ç”¨systemdæ¥æ§åˆ¶å¼€æœºè‡ªå¯åº”ç”¨ç¨‹åºã€‚

åæ¥å°±é¡ºä¾¿å°è¯•è¿›ä¸€æ­¥äº†è§£ä¸€ä¸‹systemdï¼Œæ¯•ç«Ÿè¿˜æ˜¯æ¯”è¾ƒæœ‰ç”¨çš„ã€‚

## å¼€æœºè¿è¡Œå¯åŠ¨çš„åŸç†

ä¸€äº›æ”¯æŒsystemdçš„è½¯ä»¶ï¼Œåœ¨å®‰è£…æ—¶ä¼šåœ¨`/usr/lib/systemd/system`ç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ªæ”¯æŒsystemdçš„é…ç½®æ–‡ä»¶ã€‚å½“æˆ‘ä»¬ä½¿ç”¨`systemctl enable apache2`æ—¶ï¼Œå°±ç›¸å½“äºå°†`/usr/lib/systemd/system`ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶æ·»åŠ ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œé“¾æ¥åˆ°`/etc/systemd/system`ç›®å½•ã€‚

å½“æˆ‘ä»¬çš„ç³»ç»Ÿå¼€æœºæ—¶ï¼Œsystemdä¼šæ‰§è¡Œ`/etc/systemd/system`ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ï¼Œä»¥è¾¾åˆ°å¼€æœºè‡ªå¯çš„æ•ˆæœã€‚

æœ€è¿‘å‘ç°å½“å‰è¾ƒæ–°çš„å‘è¡Œç‰ˆï¼Œä½¿ç”¨enableå‘½ä»¤æ—¶ï¼Œåˆ›å»ºçš„é“¾æ¥ç›®å½•ä¸ºï¼š

```
~ systemctl enable httpd             
Created symlink from /etc/systemd/system/multi-user.target.wants/httpd.service to /usr/lib/systemd/system/httpd.service.
```

## é…ç½®æ–‡ä»¶

å‡ æ¡å¸¸ç”¨ä¸”ç†Ÿæ‚‰çš„sysemctlçš„å‘½ä»¤è¿™é‡Œå°±ä¸åœ¨è¯¦ç»†ä»‹ç»äº†ã€‚è¿™é‡Œç›´æ¥äº†è§£ä¸€ä¸‹æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œé…ç½®æ–‡ä»¶ã€‚

æ—©åœ¨å¾ˆä¹…ä»¥å‰ï¼Œå¯¹äº[Nyncat](https://www.defectink.com/defect/12.html)è¿™ç¯‡æ–‡ç« ï¼Œé‡Œé¢å°±ä½¿ç”¨åˆ°è‡ªå·±ç¼–å†™systemdçš„é…ç½®æ–‡ä»¶æ¥è¾¾åˆ°å¯¹nyancatè¿™ä¸ªæœåŠ¡çš„è¯¦ç»†æ§åˆ¶ã€‚ï¼ˆè™½ç„¶å½“æ—¶æˆ‘ä¸ç†è§£é…ç½®æ–‡ä»¶è¯´çš„å•¥â€¦

ä¸Šè¿°äº†è§£åˆ°ï¼Œé…ç½®æ–‡ä»¶ä¸€èˆ¬æƒ…å†µä¸‹å‡ºç°åœ¨ä¸¤ä¸ªåœ°æ–¹ï¼š`/usr/lib/systemd/system`ç›®å½•å’Œ`/etc/systemd/system/multi-user.target.wants`ç›®å½•ã€‚å¯¹äºå®Œå…¨ä¸äº†è§£é…ç½®æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåœ¨è¿™ä¸¤ä¸ªç›®å½•æ‰¾ä¸ªæ¡ˆä¾‹äº†è§£ä¸€ä¸‹ã€‚

**æŸäº›Ubuntuçš„å‘è¡Œç‰ˆå¯èƒ½åœ¨`/lib/systemd/system`ç›®å½•ä¸‹ä¿å­˜é…ç½®æ–‡ä»¶**

ä¾‹å¦‚ï¼ŒCentOSçš„httpdï¼š

```
[Unit]
Description=The Apache HTTP Server
After=network.target remote-fs.target nss-lookup.target
Documentation=man:httpd(8)
Documentation=man:apachectl(8)

[Service]
Type=notify
EnvironmentFile=/etc/sysconfig/httpd
ExecStart=/usr/sbin/httpd $OPTIONS -DFOREGROUND
ExecReload=/usr/sbin/httpd $OPTIONS -k graceful
ExecStop=/bin/kill -WINCH ${MAINPID}
# We want systemd to give httpd some time to finish gracefully, but still want
# it to kill httpd after TimeoutStopSec if something went wrong during the
# graceful stop. Normally, Systemd sends SIGTERM signal right after the
# ExecStop, which would kill httpd. We are sending useless SIGCONT here to give
# httpd time to finish.
KillSignal=SIGCONT
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼Œå®ƒåŸºæœ¬ä¸Šåˆ†ä¸ºä¸‰ä¸ªåŒºå—ï¼š`Unit`ã€`Service`å’Œ`Install`åŒºå—ã€‚

### UnitåŒºåŸŸ

UnitåŒºåŸŸç”¨äºè§£é‡Šå¯åŠ¨é¡ºåºä¸ä¾èµ–å…³ç³»ã€‚å¯ä»¥ç›´è§‚çš„çœ‹åˆ°å®ƒæœ‰å‡ ä¸ªå­—æ®µï¼š

- Description
- After
- Documentation

ç¬¬ä¸€çœ¼çœ‹ä¸Šå»å¯èƒ½éƒ½æ˜¯æ¯”è¾ƒä¹±ä¸ƒå…«ç³Ÿçš„ï¼Œæ ¹æœ¬ä¸çŸ¥é“å®ƒåœ¨è¯´å•¥ã€‚ä½†æ˜¯æˆ‘ä»¬æ‹†å¼€æ¥ä¸€ä¸ªä¸€ä¸ªäº†è§£ï¼Œå°±ä¼šå‘ç°å®ƒæ„ä¹‰éå¸¸çš„ç®€å•ã€‚

**Description**ï¼šç”¨äºç»™å‡ºå½“å‰æœåŠ¡çš„ç®€å•æè¿°ã€‚é€šå¸¸æˆ‘ä»¬æŸ¥çœ‹æœåŠ¡çŠ¶æ€æ—¶ï¼Œéƒ½ä¼šåœ¨ç¬¬ä¸€è¡Œçœ‹åˆ°è¿™ä¹ˆä¸€å¥è¯ï¼š

```
httpd.service - The Apache HTTP Server
```

è¿™å°±æ˜¯`Descipton`å­—æ®µçš„ä½œç”¨ï¼Œä¸€å¥è¯å¯¹å½“å‰æœåŠ¡çš„ç®€å•ä»‹ç»ã€‚

**After**ï¼šè¯¥å­—æ®µæ˜¯æœ‰å…³äºå¯åŠ¨é¡ºåºçš„å­—æ®µï¼Œä»å­—é¢æ„æ€æˆ‘ä»¬å°±åº”è¯¥å¤§æ¦‚äº†è§£åˆ°ï¼Œè¿™ä¸ªå€¼åº”è¯¥æ˜¯å®šä¹‰å½“å‰æœåŠ¡åº”è¯¥å¯åŠ¨åœ¨å“ªäº›æœåŠ¡ä¹‹åã€‚

ä¸Šè¿°é…ç½®æ–‡ä»¶è¯¥å€¼è§£é‡Šå°±æ˜¯ï¼šå½“`network.target remote-fs.target nss-lookup.target`è¿™äº›æœåŠ¡éœ€è¦å¯åŠ¨ï¼Œé‚£ä¹ˆå½“å‰çš„`httpd.service`åº”è¯¥åœ¨ä»–ä»¬ä¹‹åå¯åŠ¨ã€‚

ç›¸å¯¹çš„ï¼Œå’Œ`After`å¯¹åº”çš„è¿˜æœ‰ä¸ª`Before`å­—æ®µã€‚äº†è§£äº†`After`è¿™ä¸ª`Before`å°±åº”è¯¥å¾ˆå®¹æ˜“ç†è§£äº†ã€‚å®Œå…¨å’Œ`After`ç›¸å¯¹çš„æ„æ€ï¼Œå®šä¹‰`httpd.service`åº”è¯¥åœ¨å“ªäº›æœåŠ¡ä¹‹å‰å¯åŠ¨ã€‚

Afterå’ŒBeforeåªå…³ä¹åˆ°æœåŠ¡çš„å¯åŠ¨é¡ºåºï¼Œå¹¶ä¸å…³ä¹åˆ°ä¾èµ–å…³ç³»ã€‚

**Documentation**ï¼šè¯¥å­—æ®µæ¯”è¾ƒç®€å•ï¼Œå’Œ`Descripton`ä½œç”¨å·®ä¸å¤šã€‚å®ƒçš„å€¼ç”¨äºç»™å‡ºå½“å‰æœåŠ¡çš„æ–‡æ¡£çš„ä½ç½®ã€‚

å½“å‰é…ç½®æ–‡ä»¶ä¸­å¹¶æ²¡æœ‰è¯´æ˜ä¾èµ–å…³ç³»çš„å­—æ®µã€‚ä¾èµ–å…³ç³»å’Œå¯åŠ¨é¡ºåºéƒ½æ˜¯å†™åœ¨å½“å‰è¿™ä¸ªUnitåŒºåŸŸçš„ï¼Œå®ƒä¿©éå¸¸åƒè±¡ï¼Œä½†æ˜¯ä½œç”¨ä¸åŒã€‚

ä¾èµ–å…³ç³»æœ‰ä¸¤ä¸ªå­—æ®µè¿›è¡Œæ§åˆ¶ï¼š`Wants`å’Œ`Requiers`ã€‚

**Wants**ï¼šè¡¨ç¤ºå¼±ä¾èµ–å…³ç³»ï¼Œå³ä½¿è¯¥å€¼å†…çš„æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œä¹Ÿä¸å½±å“å½“å‰æœåŠ¡çš„ç»§ç»­è¿è¡Œã€‚

**Requires**ï¼šè¡¨ç¤ºå¼ºä¾èµ–å…³ç³»ï¼Œå¦‚æœè¯¥å€¼å†…çš„æœåŠ¡æ— æ³•è¿è¡Œï¼Œé‚£ä¹ˆå½“å‰æœåŠ¡ä¹Ÿå°†åœæ­¢ã€‚

æ‰“ä¸ªæ¯”æ–¹ï¼š

å½“å‰çš„httpd.serviceéœ€è¦ä¾èµ–mysqlæ¥å­˜å‚¨æ•°æ®ã€‚å¦‚æœåœ¨é…ç½®æ–‡ä»¶ä¸­å®ƒåªå®šä¹‰äº†åœ¨mysqlä¹‹åå¯åŠ¨ã€‚è€Œæ²¡å®šä¹‰ä¾èµ–å…³ç³»ï¼Œé‚£ä¹ˆå½“mysqlå‡ºç°é”™è¯¯åœæ­¢æ—¶ï¼Œåœ¨é‡æ–°å¯åŠ¨æœŸé—´ï¼Œå½“å‰çš„httpdå°†æ— æ³•ä¸mysqlå»ºç«‹é“¾æ¥ã€‚

**è¿™é‡Œåªæ˜¯æ‰“ä¸ªæ¯”æ–¹å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„äº†è§£ï¼Œå®é™…æƒ…å†µä¸‹httpdåœ¨é€šå¸¸å’Œmysqlæ˜¯æ²¡æœ‰è¿™æ ·çš„ä¾èµ–å…³ç³»çš„ğŸ¥ã€‚**

### ServiceåŒºåŸŸ

ServiceåŒºåŸŸæ˜¯ä¸»è¦çš„ä¸€éƒ¨åˆ†ï¼Œä¸»è¦æ§åˆ¶è½¯ä»¶çš„å¯åŠ¨åœæ­¢ç­‰ï¼Œéƒ½æ˜¯åœ¨æ­¤éƒ¨åˆ†å£°æ˜çš„ã€‚ä¹Ÿå°±æ˜¯å®šä¹‰äº†å¦‚ä½•å¯åŠ¨å½“å‰çš„æœåŠ¡ã€‚

è®¸å¤šè½¯ä»¶éƒ½æœ‰ç¯å¢ƒå‚æ•°æ–‡ä»¶ï¼Œä½¿ç”¨`EnvironmentFile`å­—æ®µä¾¿å¯ä»¥å®šä¹‰ç¯å¢ƒå‚æ•°ã€‚

`EnvironmentFile`å­—æ®µï¼šæŒ‡å®šå½“å‰æœåŠ¡çš„ç¯å¢ƒå‚æ•°æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å†…éƒ¨çš„`key=value`é”®å€¼å¯¹ï¼Œå¯ä»¥ç”¨`$key`çš„å½¢å¼ï¼Œåœ¨å½“å‰é…ç½®æ–‡ä»¶ä¸­è·å–ã€‚

ä¾‹å¦‚ï¼Œå¯åŠ¨`sshd`ï¼Œæ‰§è¡Œçš„å‘½ä»¤æ˜¯`/usr/sbin/sshd -D $OPTIONS`ï¼Œå…¶ä¸­çš„å˜é‡`$OPTIONS`å°±æ¥è‡ª`EnvironmentFile`å­—æ®µæŒ‡å®šçš„ç¯å¢ƒå‚æ•°æ–‡ä»¶ã€‚

é™¤æ­¤ä¹‹å¤–ï¼ŒServiceåŒºåŸŸè¿˜æœ‰ä¸€äº›å…³äºæ§åˆ¶è½¯ä»¶è¡Œä¸ºçš„ä¸€äº›å­—æ®µï¼š

* `ExecStart`å­—æ®µï¼šå®šä¹‰å¯åŠ¨è¿›ç¨‹æ—¶æ‰§è¡Œçš„å‘½ä»¤ã€‚

- `ExecReload`å­—æ®µï¼šé‡å¯æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤
- `ExecStop`å­—æ®µï¼šåœæ­¢æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤
- `ExecStartPre`å­—æ®µï¼šå¯åŠ¨æœåŠ¡ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤
- `ExecStartPost`å­—æ®µï¼šå¯åŠ¨æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤
- `ExecStopPost`å­—æ®µï¼šåœæ­¢æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤

æ‰€æœ‰çš„å¯åŠ¨è®¾ç½®ä¹‹å‰ï¼Œéƒ½å¯ä»¥åŠ ä¸Šä¸€ä¸ªè¿è¯å·ï¼ˆ`-`ï¼‰ï¼Œè¡¨ç¤º"æŠ‘åˆ¶é”™è¯¯"ï¼Œå³å‘ç”Ÿé”™è¯¯çš„æ—¶å€™ï¼Œä¸å½±å“å…¶ä»–å‘½ä»¤çš„æ‰§è¡Œã€‚æ¯”å¦‚ï¼Œ`EnvironmentFile=-/etc/sysconfig/sshd`ï¼ˆæ³¨æ„ç­‰å·åé¢çš„é‚£ä¸ªè¿è¯å·ï¼‰ï¼Œå°±è¡¨ç¤ºå³ä½¿`/etc/sysconfig/sshd`æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¹Ÿä¸ä¼šæŠ›å‡ºé”™è¯¯ã€‚

æ­¤å¤–ï¼ŒServiceä¸­è¿˜æœ‰å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ

**Type**å­—æ®µï¼Œå®ƒæœ‰å¦‚ä¸‹ä¸€äº›å€¼ï¼š

- simpleï¼ˆé»˜è®¤å€¼ï¼‰ï¼š`ExecStart`å­—æ®µå¯åŠ¨çš„è¿›ç¨‹ä¸ºä¸»è¿›ç¨‹
- forkingï¼š`ExecStart`å­—æ®µå°†ä»¥`fork()`æ–¹å¼å¯åŠ¨ï¼Œæ­¤æ—¶çˆ¶è¿›ç¨‹å°†ä¼šé€€å‡ºï¼Œå­è¿›ç¨‹å°†æˆä¸ºä¸»è¿›ç¨‹
- oneshotï¼šç±»ä¼¼äº`simple`ï¼Œä½†åªæ‰§è¡Œä¸€æ¬¡ï¼ŒSystemd ä¼šç­‰å®ƒæ‰§è¡Œå®Œï¼Œæ‰å¯åŠ¨å…¶ä»–æœåŠ¡
- dbusï¼šç±»ä¼¼äº`simple`ï¼Œä½†ä¼šç­‰å¾… D-Bus ä¿¡å·åå¯åŠ¨
- notifyï¼šç±»ä¼¼äº`simple`ï¼Œå¯åŠ¨ç»“æŸåä¼šå‘å‡ºé€šçŸ¥ä¿¡å·ï¼Œç„¶å Systemd å†å¯åŠ¨å…¶ä»–æœåŠ¡
- idleï¼šç±»ä¼¼äº`simple`ï¼Œä½†æ˜¯è¦ç­‰åˆ°å…¶ä»–ä»»åŠ¡éƒ½æ‰§è¡Œå®Œï¼Œæ‰ä¼šå¯åŠ¨è¯¥æœåŠ¡ã€‚ä¸€ç§ä½¿ç”¨åœºåˆæ˜¯ä¸ºè®©è¯¥æœåŠ¡çš„è¾“å‡ºï¼Œä¸ä¸å…¶ä»–æœåŠ¡çš„è¾“å‡ºç›¸æ··åˆ

### InstallåŒºåŸŸ

`Install`åŒºå—ï¼Œå®šä¹‰å¦‚ä½•å®‰è£…è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå³æ€æ ·åšåˆ°å¼€æœºå¯åŠ¨ã€‚

`WantedBy`å­—æ®µï¼šè¡¨ç¤ºè¯¥æœåŠ¡æ‰€åœ¨çš„ Targetã€‚

`Target`çš„å«ä¹‰æ˜¯æœåŠ¡ç»„ï¼Œè¡¨ç¤ºä¸€ç»„æœåŠ¡ã€‚`WantedBy=multi-user.target`æŒ‡çš„æ˜¯ï¼Œsshd æ‰€åœ¨çš„ Target æ˜¯`multi-user.target`ã€‚

è¿™ä¸ªè®¾ç½®éå¸¸é‡è¦ï¼Œå› ä¸ºæ‰§è¡Œ`systemctl enable sshd.service`å‘½ä»¤æ—¶ï¼Œ`sshd.service`çš„ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œå°±ä¼šæ”¾åœ¨`/etc/systemd/system`ç›®å½•ä¸‹é¢çš„`multi-user.target.wants`å­ç›®å½•ä¹‹ä¸­ã€‚

Systemd æœ‰é»˜è®¤çš„å¯åŠ¨ Targetã€‚

 ```bash
 $ systemctl get-default
 multi-user.target
 ```

ä¸€èˆ¬æ¥è¯´ï¼Œå¸¸ç”¨çš„ Target æœ‰ä¸¤ä¸ªï¼šä¸€ä¸ªæ˜¯`multi-user.target`ï¼Œè¡¨ç¤ºå¤šç”¨æˆ·å‘½ä»¤è¡ŒçŠ¶æ€ï¼›å¦ä¸€ä¸ªæ˜¯`graphical.target`ï¼Œè¡¨ç¤ºå›¾å½¢ç”¨æˆ·çŠ¶æ€ï¼Œå®ƒä¾èµ–äº`multi-user.target`ã€‚å®˜æ–¹æ–‡æ¡£æœ‰ä¸€å¼ éå¸¸æ¸…æ™°çš„ [Target ä¾èµ–å…³ç³»å›¾](https://www.freedesktop.org/software/systemd/man/bootup.html#System Manager Bootup)ã€‚

Target ä¹Ÿæœ‰è‡ªå·±çš„é…ç½®æ–‡ä»¶ã€‚

```bash
$ systemctl cat multi-user.target

[Unit]
Description=Multi-User System
Documentation=man:systemd.special(7)
Requires=basic.target
Conflicts=rescue.service rescue.target
After=basic.target rescue.service rescue.target
AllowIsolate=yes
```

## è¯¦ç»†çš„å­—æ®µè§£é‡Š

```
[Unit]
Description : æœåŠ¡çš„ç®€å•æè¿°
Documentation ï¼š æœåŠ¡æ–‡æ¡£
Beforeã€After:å®šä¹‰å¯åŠ¨é¡ºåºã€‚Before=xxx.service,ä»£è¡¨æœ¬æœåŠ¡åœ¨xxx.serviceå¯åŠ¨ä¹‹å‰å¯åŠ¨ã€‚After=xxx.service,ä»£è¡¨æœ¬æœåŠ¡åœ¨xxx.serviceä¹‹åå¯åŠ¨ã€‚
Requiresï¼šè¿™ä¸ªå•å…ƒå¯åŠ¨äº†ï¼Œå®ƒéœ€è¦çš„å•å…ƒä¹Ÿä¼šè¢«å¯åŠ¨ï¼›å®ƒéœ€è¦çš„å•å…ƒè¢«åœæ­¢äº†ï¼Œè¿™ä¸ªå•å…ƒä¹Ÿåœæ­¢äº†ã€‚
Wantsï¼šæ¨èä½¿ç”¨ã€‚è¿™ä¸ªå•å…ƒå¯åŠ¨äº†ï¼Œå®ƒéœ€è¦çš„å•å…ƒä¹Ÿä¼šè¢«å¯åŠ¨ï¼›å®ƒéœ€è¦çš„å•å…ƒè¢«åœæ­¢äº†ï¼Œå¯¹æœ¬å•å…ƒæ²¡æœ‰å½±å“ã€‚
```

```
[Service]
Type=simpleï¼ˆé»˜è®¤å€¼ï¼‰ï¼šsystemdè®¤ä¸ºè¯¥æœåŠ¡å°†ç«‹å³å¯åŠ¨ã€‚æœåŠ¡è¿›ç¨‹ä¸ä¼šforkã€‚å¦‚æœè¯¥æœåŠ¡è¦å¯åŠ¨å…¶ä»–æœåŠ¡ï¼Œä¸è¦ä½¿ç”¨æ­¤ç±»å‹å¯åŠ¨ï¼Œé™¤éè¯¥æœåŠ¡æ˜¯socketæ¿€æ´»å‹ã€‚
Type=forkingï¼šsystemdè®¤ä¸ºå½“è¯¥æœåŠ¡è¿›ç¨‹forkï¼Œä¸”çˆ¶è¿›ç¨‹é€€å‡ºåæœåŠ¡å¯åŠ¨æˆåŠŸã€‚å¯¹äºå¸¸è§„çš„å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰ï¼Œé™¤éä½ ç¡®å®šæ­¤å¯åŠ¨æ–¹å¼æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œä½¿ç”¨æ­¤ç±»å‹å¯åŠ¨å³å¯ã€‚ä½¿ç”¨æ­¤å¯åŠ¨ç±»å‹åº”åŒæ—¶æŒ‡å®š PIDFile=ï¼Œä»¥ä¾¿systemdèƒ½å¤Ÿè·Ÿè¸ªæœåŠ¡çš„ä¸»è¿›ç¨‹ã€‚
Type=oneshotï¼šè¿™ä¸€é€‰é¡¹é€‚ç”¨äºåªæ‰§è¡Œä¸€é¡¹ä»»åŠ¡ã€éšåç«‹å³é€€å‡ºçš„æœåŠ¡ã€‚å¯èƒ½éœ€è¦åŒæ—¶è®¾ç½® RemainAfterExit=yes ä½¿å¾— systemd åœ¨æœåŠ¡è¿›ç¨‹é€€å‡ºä¹‹åä»ç„¶è®¤ä¸ºæœåŠ¡å¤„äºæ¿€æ´»çŠ¶æ€ã€‚
Type=notifyï¼šä¸ Type=simple ç›¸åŒï¼Œä½†çº¦å®šæœåŠ¡ä¼šåœ¨å°±ç»ªåå‘ systemd å‘é€ä¸€ä¸ªä¿¡å·ã€‚è¿™ä¸€é€šçŸ¥çš„å®ç°ç”± libsystemd-daemon.so æä¾›ã€‚
Type=dbusï¼šè‹¥ä»¥æ­¤æ–¹å¼å¯åŠ¨ï¼Œå½“æŒ‡å®šçš„ BusName å‡ºç°åœ¨DBusç³»ç»Ÿæ€»çº¿ä¸Šæ—¶ï¼Œsystemdè®¤ä¸ºæœåŠ¡å°±ç»ªã€‚
Type=idle: systemdä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡(Jobs)å¤„ç†å®Œæˆåï¼Œæ‰å¼€å§‹æ‰§è¡Œidleç±»å‹çš„å•å…ƒã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå…¶ä»–è¡Œä¸ºå’ŒType=simple ç±»ä¼¼ã€‚
PIDFileï¼špidæ–‡ä»¶è·¯å¾„
ExecStartPreï¼šåœæ­¢æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤
ExecStartï¼šæŒ‡å®šå¯åŠ¨å•å…ƒçš„å‘½ä»¤æˆ–è€…è„šæœ¬ï¼ŒExecStartPreå’ŒExecStartPostèŠ‚æŒ‡å®šåœ¨ExecStartä¹‹å‰æˆ–è€…ä¹‹åç”¨æˆ·è‡ªå®šä¹‰æ‰§è¡Œçš„è„šæœ¬ã€‚Type=oneshotå…è®¸æŒ‡å®šå¤šä¸ªå¸Œæœ›é¡ºåºæ‰§è¡Œçš„ç”¨æˆ·è‡ªå®šä¹‰å‘½ä»¤ã€‚
ExecReloadï¼šæŒ‡å®šå•å…ƒåœæ­¢æ—¶æ‰§è¡Œçš„å‘½ä»¤æˆ–è€…è„šæœ¬ã€‚
ExecStopï¼šæŒ‡å®šå•å…ƒåœæ­¢æ—¶æ‰§è¡Œçš„å‘½ä»¤æˆ–è€…è„šæœ¬ã€‚
ExecStopPostï¼šåœæ­¢æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤
ExecStartPostï¼šå¯åŠ¨æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤
PrivateTmpï¼šTrueè¡¨ç¤ºç»™æœåŠ¡åˆ†é…ç‹¬ç«‹çš„ä¸´æ—¶ç©ºé—´
Restartï¼šè¿™ä¸ªé€‰é¡¹å¦‚æœè¢«å…è®¸ï¼ŒæœåŠ¡é‡å¯çš„æ—¶å€™è¿›ç¨‹ä¼šé€€å‡ºï¼Œä¼šé€šè¿‡systemctlå‘½ä»¤æ‰§è¡Œæ¸…é™¤å¹¶é‡å¯çš„æ“ä½œã€‚
RemainAfterExitï¼šå¦‚æœè®¾ç½®è¿™ä¸ªé€‰æ‹©ä¸ºçœŸï¼ŒæœåŠ¡ä¼šè¢«è®¤ä¸ºæ˜¯åœ¨æ¿€æ´»çŠ¶æ€ï¼Œå³ä½¿æ‰€ä»¥çš„è¿›ç¨‹å·²ç»é€€å‡ºï¼Œé»˜è®¤çš„å€¼ä¸ºå‡ï¼Œè¿™ä¸ªé€‰é¡¹åªæœ‰åœ¨Type=oneshotæ—¶éœ€è¦è¢«é…ç½®ã€‚
```

```
[Install]
Aliasï¼šä¸ºå•å…ƒæä¾›ä¸€ä¸ªç©ºé—´åˆ†ç¦»çš„é™„åŠ åå­—ã€‚
RequiredByï¼šå•å…ƒè¢«å…è®¸è¿è¡Œéœ€è¦çš„ä¸€ç³»åˆ—ä¾èµ–å•å…ƒï¼ŒRequiredByåˆ—è¡¨ä»Requireè·å¾—ä¾èµ–ä¿¡æ¯ã€‚
WantByï¼šå•å…ƒè¢«å…è®¸è¿è¡Œéœ€è¦çš„å¼±ä¾èµ–æ€§å•å…ƒï¼ŒWantbyä»Wantåˆ—è¡¨è·å¾—ä¾èµ–ä¿¡æ¯ã€‚
Alsoï¼šæŒ‡å‡ºå’Œå•å…ƒä¸€èµ·å®‰è£…æˆ–è€…è¢«ååŠ©çš„å•å…ƒã€‚
DefaultInstanceï¼šå®ä¾‹å•å…ƒçš„é™åˆ¶ï¼Œè¿™ä¸ªé€‰é¡¹æŒ‡å®šå¦‚æœå•å…ƒè¢«å…è®¸è¿è¡Œé»˜è®¤çš„å®ä¾‹ã€‚
```

## é‡å¯

```bash
# é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶
$ sudo systemctl daemon-reload

# é‡å¯ç›¸å…³æœåŠ¡
$ sudo systemctl restart foobar
```
=======
---
title: systemd çš„åŸºç¡€æ“ä½œ
date: 2019-06-14 14:42:41
tags: Linux
categories: Linux
url: basic-knowledge-of-systemd
index_img: /images/systemdçš„åŸºç¡€æ“ä½œ/logo.webp
---

## ä»€ä¹ˆæ˜¯systemdï¼Ÿ

Systemdæ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ä¸€äº›Linuxå‘è¡Œç‰ˆä¸­å¸¸è§çš„ä¸€å¥—ä¸­å¤®åŒ–ç³»ç»ŸåŠè®¾ç½®ç®¡ç†ç¨‹åº(init)ï¼ŒåŒ…æ‹¬æœ‰[å®ˆæŠ¤è¿›ç¨‹](https://zh.wikipedia.org/wiki/%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B)ã€[ç¨‹åºåº“](https://zh.wikipedia.org/wiki/%E7%A8%8B%E5%BC%8F%E5%BA%AB)ä»¥åŠåº”ç”¨è½¯ä»¶ã€‚

æˆ‘ä»¬ç»å¸¸ä½¿ç”¨`systemctl start apache2`æ¥å¯åŠ¨ä¸€äº›æœåŠ¡æˆ–è€…åº”ç”¨è½¯ä»¶æ—¶ï¼Œä½¿ç”¨åˆ°çš„å°±æ˜¯Systemdçš„ä¸€éƒ¨åˆ†ã€‚

å½“å‰ç»å¤§å¤šæ•°çš„Linuxå‘è¡Œç‰ˆéƒ½å·²é‡‡ç”¨systemdä»£æ›¿åŸæ¥çš„[System V](https://zh.wikipedia.org/wiki/UNIX_System_V)ã€‚

## å­¦ä¹ å®ƒçš„ä½œç”¨ï¼Ÿ

å®ƒèƒ½å¤Ÿæ–¹ä¾¿çš„å¯¹ä¸€äº›è½¯ä»¶è¿è¡Œè¿›è¡Œç®¡ç†ï¼Œç»å¸¸ä½¿ç”¨`systemctl`çš„åŒå­¦ä»¬å¯èƒ½ä¼šæ¯”è¾ƒäº†è§£ï¼Œè­¬å¦‚æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ï¼Œè®¾ç½®å¼€æœºè‡ªå¯ç­‰æ“ä½œã€‚

æœ€è¿‘å°é²œäº†Ubuntuï¼Œä½†æ˜¯é‡åˆ°ä¸ªæ–°çš„é—®é¢˜ã€‚åœ¨Ubuntu 18.10ä¸­ï¼Œå·²ç»å°†ä»¥å‰çš„å¼€æœºè‡ªå¯åŠ¨çš„è„šæœ¬`/etc/rc.local`å»æ‰äº†ã€‚æ— æ„ä¸­çœ‹åˆ°ä½¿ç”¨systemdæ¥æ§åˆ¶å¼€æœºè‡ªå¯åº”ç”¨ç¨‹åºã€‚

åæ¥å°±é¡ºä¾¿å°è¯•è¿›ä¸€æ­¥äº†è§£ä¸€ä¸‹systemdï¼Œæ¯•ç«Ÿè¿˜æ˜¯æ¯”è¾ƒæœ‰ç”¨çš„ã€‚

## å¼€æœºè¿è¡Œå¯åŠ¨çš„åŸç†

ä¸€äº›æ”¯æŒsystemdçš„è½¯ä»¶ï¼Œåœ¨å®‰è£…æ—¶ä¼šåœ¨`/usr/lib/systemd/system`ç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ªæ”¯æŒsystemdçš„é…ç½®æ–‡ä»¶ã€‚å½“æˆ‘ä»¬ä½¿ç”¨`systemctl enable apache2`æ—¶ï¼Œå°±ç›¸å½“äºå°†`/usr/lib/systemd/system`ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶æ·»åŠ ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œé“¾æ¥åˆ°`/etc/systemd/system`ç›®å½•ã€‚

å½“æˆ‘ä»¬çš„ç³»ç»Ÿå¼€æœºæ—¶ï¼Œsystemdä¼šæ‰§è¡Œ`/etc/systemd/system`ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ï¼Œä»¥è¾¾åˆ°å¼€æœºè‡ªå¯çš„æ•ˆæœã€‚

æœ€è¿‘å‘ç°å½“å‰è¾ƒæ–°çš„å‘è¡Œç‰ˆï¼Œä½¿ç”¨enableå‘½ä»¤æ—¶ï¼Œåˆ›å»ºçš„é“¾æ¥ç›®å½•ä¸ºï¼š

```
~ systemctl enable httpd             
Created symlink from /etc/systemd/system/multi-user.target.wants/httpd.service to /usr/lib/systemd/system/httpd.service.
```

## é…ç½®æ–‡ä»¶

å‡ æ¡å¸¸ç”¨ä¸”ç†Ÿæ‚‰çš„sysemctlçš„å‘½ä»¤è¿™é‡Œå°±ä¸åœ¨è¯¦ç»†ä»‹ç»äº†ã€‚è¿™é‡Œç›´æ¥äº†è§£ä¸€ä¸‹æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œé…ç½®æ–‡ä»¶ã€‚

æ—©åœ¨å¾ˆä¹…ä»¥å‰ï¼Œå¯¹äº[Nyncat](https://www.defectink.com/defect/12.html)è¿™ç¯‡æ–‡ç« ï¼Œé‡Œé¢å°±ä½¿ç”¨åˆ°è‡ªå·±ç¼–å†™systemdçš„é…ç½®æ–‡ä»¶æ¥è¾¾åˆ°å¯¹nyancatè¿™ä¸ªæœåŠ¡çš„è¯¦ç»†æ§åˆ¶ã€‚ï¼ˆè™½ç„¶å½“æ—¶æˆ‘ä¸ç†è§£é…ç½®æ–‡ä»¶è¯´çš„å•¥â€¦

ä¸Šè¿°äº†è§£åˆ°ï¼Œé…ç½®æ–‡ä»¶ä¸€èˆ¬æƒ…å†µä¸‹å‡ºç°åœ¨ä¸¤ä¸ªåœ°æ–¹ï¼š`/usr/lib/systemd/system`ç›®å½•å’Œ`/etc/systemd/system/multi-user.target.wants`ç›®å½•ã€‚å¯¹äºå®Œå…¨ä¸äº†è§£é…ç½®æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåœ¨è¿™ä¸¤ä¸ªç›®å½•æ‰¾ä¸ªæ¡ˆä¾‹äº†è§£ä¸€ä¸‹ã€‚

**æŸäº›Ubuntuçš„å‘è¡Œç‰ˆå¯èƒ½åœ¨`/lib/systemd/system`ç›®å½•ä¸‹ä¿å­˜é…ç½®æ–‡ä»¶**

ä¾‹å¦‚ï¼ŒCentOSçš„httpdï¼š

```
[Unit]
Description=The Apache HTTP Server
After=network.target remote-fs.target nss-lookup.target
Documentation=man:httpd(8)
Documentation=man:apachectl(8)

[Service]
Type=notify
EnvironmentFile=/etc/sysconfig/httpd
ExecStart=/usr/sbin/httpd $OPTIONS -DFOREGROUND
ExecReload=/usr/sbin/httpd $OPTIONS -k graceful
ExecStop=/bin/kill -WINCH ${MAINPID}
# We want systemd to give httpd some time to finish gracefully, but still want
# it to kill httpd after TimeoutStopSec if something went wrong during the
# graceful stop. Normally, Systemd sends SIGTERM signal right after the
# ExecStop, which would kill httpd. We are sending useless SIGCONT here to give
# httpd time to finish.
KillSignal=SIGCONT
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼Œå®ƒåŸºæœ¬ä¸Šåˆ†ä¸ºä¸‰ä¸ªåŒºå—ï¼š`Unit`ã€`Service`å’Œ`Install`åŒºå—ã€‚

### UnitåŒºåŸŸ

UnitåŒºåŸŸç”¨äºè§£é‡Šå¯åŠ¨é¡ºåºä¸ä¾èµ–å…³ç³»ã€‚å¯ä»¥ç›´è§‚çš„çœ‹åˆ°å®ƒæœ‰å‡ ä¸ªå­—æ®µï¼š

- Description
- After
- Documentation

ç¬¬ä¸€çœ¼çœ‹ä¸Šå»å¯èƒ½éƒ½æ˜¯æ¯”è¾ƒä¹±ä¸ƒå…«ç³Ÿçš„ï¼Œæ ¹æœ¬ä¸çŸ¥é“å®ƒåœ¨è¯´å•¥ã€‚ä½†æ˜¯æˆ‘ä»¬æ‹†å¼€æ¥ä¸€ä¸ªä¸€ä¸ªäº†è§£ï¼Œå°±ä¼šå‘ç°å®ƒæ„ä¹‰éå¸¸çš„ç®€å•ã€‚

**Description**ï¼šç”¨äºç»™å‡ºå½“å‰æœåŠ¡çš„ç®€å•æè¿°ã€‚é€šå¸¸æˆ‘ä»¬æŸ¥çœ‹æœåŠ¡çŠ¶æ€æ—¶ï¼Œéƒ½ä¼šåœ¨ç¬¬ä¸€è¡Œçœ‹åˆ°è¿™ä¹ˆä¸€å¥è¯ï¼š

```
httpd.service - The Apache HTTP Server
```

è¿™å°±æ˜¯`Descipton`å­—æ®µçš„ä½œç”¨ï¼Œä¸€å¥è¯å¯¹å½“å‰æœåŠ¡çš„ç®€å•ä»‹ç»ã€‚

**After**ï¼šè¯¥å­—æ®µæ˜¯æœ‰å…³äºå¯åŠ¨é¡ºåºçš„å­—æ®µï¼Œä»å­—é¢æ„æ€æˆ‘ä»¬å°±åº”è¯¥å¤§æ¦‚äº†è§£åˆ°ï¼Œè¿™ä¸ªå€¼åº”è¯¥æ˜¯å®šä¹‰å½“å‰æœåŠ¡åº”è¯¥å¯åŠ¨åœ¨å“ªäº›æœåŠ¡ä¹‹åã€‚

ä¸Šè¿°é…ç½®æ–‡ä»¶è¯¥å€¼è§£é‡Šå°±æ˜¯ï¼šå½“`network.target remote-fs.target nss-lookup.target`è¿™äº›æœåŠ¡éœ€è¦å¯åŠ¨ï¼Œé‚£ä¹ˆå½“å‰çš„`httpd.service`åº”è¯¥åœ¨ä»–ä»¬ä¹‹åå¯åŠ¨ã€‚

ç›¸å¯¹çš„ï¼Œå’Œ`After`å¯¹åº”çš„è¿˜æœ‰ä¸ª`Before`å­—æ®µã€‚äº†è§£äº†`After`è¿™ä¸ª`Before`å°±åº”è¯¥å¾ˆå®¹æ˜“ç†è§£äº†ã€‚å®Œå…¨å’Œ`After`ç›¸å¯¹çš„æ„æ€ï¼Œå®šä¹‰`httpd.service`åº”è¯¥åœ¨å“ªäº›æœåŠ¡ä¹‹å‰å¯åŠ¨ã€‚

Afterå’ŒBeforeåªå…³ä¹åˆ°æœåŠ¡çš„å¯åŠ¨é¡ºåºï¼Œå¹¶ä¸å…³ä¹åˆ°ä¾èµ–å…³ç³»ã€‚

**Documentation**ï¼šè¯¥å­—æ®µæ¯”è¾ƒç®€å•ï¼Œå’Œ`Descripton`ä½œç”¨å·®ä¸å¤šã€‚å®ƒçš„å€¼ç”¨äºç»™å‡ºå½“å‰æœåŠ¡çš„æ–‡æ¡£çš„ä½ç½®ã€‚

å½“å‰é…ç½®æ–‡ä»¶ä¸­å¹¶æ²¡æœ‰è¯´æ˜ä¾èµ–å…³ç³»çš„å­—æ®µã€‚ä¾èµ–å…³ç³»å’Œå¯åŠ¨é¡ºåºéƒ½æ˜¯å†™åœ¨å½“å‰è¿™ä¸ªUnitåŒºåŸŸçš„ï¼Œå®ƒä¿©éå¸¸åƒè±¡ï¼Œä½†æ˜¯ä½œç”¨ä¸åŒã€‚

ä¾èµ–å…³ç³»æœ‰ä¸¤ä¸ªå­—æ®µè¿›è¡Œæ§åˆ¶ï¼š`Wants`å’Œ`Requiers`ã€‚

**Wants**ï¼šè¡¨ç¤ºå¼±ä¾èµ–å…³ç³»ï¼Œå³ä½¿è¯¥å€¼å†…çš„æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œä¹Ÿä¸å½±å“å½“å‰æœåŠ¡çš„ç»§ç»­è¿è¡Œã€‚

**Requires**ï¼šè¡¨ç¤ºå¼ºä¾èµ–å…³ç³»ï¼Œå¦‚æœè¯¥å€¼å†…çš„æœåŠ¡æ— æ³•è¿è¡Œï¼Œé‚£ä¹ˆå½“å‰æœåŠ¡ä¹Ÿå°†åœæ­¢ã€‚

æ‰“ä¸ªæ¯”æ–¹ï¼š

å½“å‰çš„httpd.serviceéœ€è¦ä¾èµ–mysqlæ¥å­˜å‚¨æ•°æ®ã€‚å¦‚æœåœ¨é…ç½®æ–‡ä»¶ä¸­å®ƒåªå®šä¹‰äº†åœ¨mysqlä¹‹åå¯åŠ¨ã€‚è€Œæ²¡å®šä¹‰ä¾èµ–å…³ç³»ï¼Œé‚£ä¹ˆå½“mysqlå‡ºç°é”™è¯¯åœæ­¢æ—¶ï¼Œåœ¨é‡æ–°å¯åŠ¨æœŸé—´ï¼Œå½“å‰çš„httpdå°†æ— æ³•ä¸mysqlå»ºç«‹é“¾æ¥ã€‚

**è¿™é‡Œåªæ˜¯æ‰“ä¸ªæ¯”æ–¹å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„äº†è§£ï¼Œå®é™…æƒ…å†µä¸‹httpdåœ¨é€šå¸¸å’Œmysqlæ˜¯æ²¡æœ‰è¿™æ ·çš„ä¾èµ–å…³ç³»çš„ğŸ¥ã€‚**

### ServiceåŒºåŸŸ

ServiceåŒºåŸŸæ˜¯ä¸»è¦çš„ä¸€éƒ¨åˆ†ï¼Œä¸»è¦æ§åˆ¶è½¯ä»¶çš„å¯åŠ¨åœæ­¢ç­‰ï¼Œéƒ½æ˜¯åœ¨æ­¤éƒ¨åˆ†å£°æ˜çš„ã€‚ä¹Ÿå°±æ˜¯å®šä¹‰äº†å¦‚ä½•å¯åŠ¨å½“å‰çš„æœåŠ¡ã€‚

è®¸å¤šè½¯ä»¶éƒ½æœ‰ç¯å¢ƒå‚æ•°æ–‡ä»¶ï¼Œä½¿ç”¨`EnvironmentFile`å­—æ®µä¾¿å¯ä»¥å®šä¹‰ç¯å¢ƒå‚æ•°ã€‚

`EnvironmentFile`å­—æ®µï¼šæŒ‡å®šå½“å‰æœåŠ¡çš„ç¯å¢ƒå‚æ•°æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å†…éƒ¨çš„`key=value`é”®å€¼å¯¹ï¼Œå¯ä»¥ç”¨`$key`çš„å½¢å¼ï¼Œåœ¨å½“å‰é…ç½®æ–‡ä»¶ä¸­è·å–ã€‚

ä¾‹å¦‚ï¼Œå¯åŠ¨`sshd`ï¼Œæ‰§è¡Œçš„å‘½ä»¤æ˜¯`/usr/sbin/sshd -D $OPTIONS`ï¼Œå…¶ä¸­çš„å˜é‡`$OPTIONS`å°±æ¥è‡ª`EnvironmentFile`å­—æ®µæŒ‡å®šçš„ç¯å¢ƒå‚æ•°æ–‡ä»¶ã€‚

é™¤æ­¤ä¹‹å¤–ï¼ŒServiceåŒºåŸŸè¿˜æœ‰ä¸€äº›å…³äºæ§åˆ¶è½¯ä»¶è¡Œä¸ºçš„ä¸€äº›å­—æ®µï¼š

* `ExecStart`å­—æ®µï¼šå®šä¹‰å¯åŠ¨è¿›ç¨‹æ—¶æ‰§è¡Œçš„å‘½ä»¤ã€‚

- `ExecReload`å­—æ®µï¼šé‡å¯æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤
- `ExecStop`å­—æ®µï¼šåœæ­¢æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤
- `ExecStartPre`å­—æ®µï¼šå¯åŠ¨æœåŠ¡ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤
- `ExecStartPost`å­—æ®µï¼šå¯åŠ¨æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤
- `ExecStopPost`å­—æ®µï¼šåœæ­¢æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤

æ‰€æœ‰çš„å¯åŠ¨è®¾ç½®ä¹‹å‰ï¼Œéƒ½å¯ä»¥åŠ ä¸Šä¸€ä¸ªè¿è¯å·ï¼ˆ`-`ï¼‰ï¼Œè¡¨ç¤º"æŠ‘åˆ¶é”™è¯¯"ï¼Œå³å‘ç”Ÿé”™è¯¯çš„æ—¶å€™ï¼Œä¸å½±å“å…¶ä»–å‘½ä»¤çš„æ‰§è¡Œã€‚æ¯”å¦‚ï¼Œ`EnvironmentFile=-/etc/sysconfig/sshd`ï¼ˆæ³¨æ„ç­‰å·åé¢çš„é‚£ä¸ªè¿è¯å·ï¼‰ï¼Œå°±è¡¨ç¤ºå³ä½¿`/etc/sysconfig/sshd`æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¹Ÿä¸ä¼šæŠ›å‡ºé”™è¯¯ã€‚

æ­¤å¤–ï¼ŒServiceä¸­è¿˜æœ‰å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ

**Type**å­—æ®µï¼Œå®ƒæœ‰å¦‚ä¸‹ä¸€äº›å€¼ï¼š

- simpleï¼ˆé»˜è®¤å€¼ï¼‰ï¼š`ExecStart`å­—æ®µå¯åŠ¨çš„è¿›ç¨‹ä¸ºä¸»è¿›ç¨‹
- forkingï¼š`ExecStart`å­—æ®µå°†ä»¥`fork()`æ–¹å¼å¯åŠ¨ï¼Œæ­¤æ—¶çˆ¶è¿›ç¨‹å°†ä¼šé€€å‡ºï¼Œå­è¿›ç¨‹å°†æˆä¸ºä¸»è¿›ç¨‹
- oneshotï¼šç±»ä¼¼äº`simple`ï¼Œä½†åªæ‰§è¡Œä¸€æ¬¡ï¼ŒSystemd ä¼šç­‰å®ƒæ‰§è¡Œå®Œï¼Œæ‰å¯åŠ¨å…¶ä»–æœåŠ¡
- dbusï¼šç±»ä¼¼äº`simple`ï¼Œä½†ä¼šç­‰å¾… D-Bus ä¿¡å·åå¯åŠ¨
- notifyï¼šç±»ä¼¼äº`simple`ï¼Œå¯åŠ¨ç»“æŸåä¼šå‘å‡ºé€šçŸ¥ä¿¡å·ï¼Œç„¶å Systemd å†å¯åŠ¨å…¶ä»–æœåŠ¡
- idleï¼šç±»ä¼¼äº`simple`ï¼Œä½†æ˜¯è¦ç­‰åˆ°å…¶ä»–ä»»åŠ¡éƒ½æ‰§è¡Œå®Œï¼Œæ‰ä¼šå¯åŠ¨è¯¥æœåŠ¡ã€‚ä¸€ç§ä½¿ç”¨åœºåˆæ˜¯ä¸ºè®©è¯¥æœåŠ¡çš„è¾“å‡ºï¼Œä¸ä¸å…¶ä»–æœåŠ¡çš„è¾“å‡ºç›¸æ··åˆ

### InstallåŒºåŸŸ

`Install`åŒºå—ï¼Œå®šä¹‰å¦‚ä½•å®‰è£…è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå³æ€æ ·åšåˆ°å¼€æœºå¯åŠ¨ã€‚

`WantedBy`å­—æ®µï¼šè¡¨ç¤ºè¯¥æœåŠ¡æ‰€åœ¨çš„ Targetã€‚

`Target`çš„å«ä¹‰æ˜¯æœåŠ¡ç»„ï¼Œè¡¨ç¤ºä¸€ç»„æœåŠ¡ã€‚`WantedBy=multi-user.target`æŒ‡çš„æ˜¯ï¼Œsshd æ‰€åœ¨çš„ Target æ˜¯`multi-user.target`ã€‚

è¿™ä¸ªè®¾ç½®éå¸¸é‡è¦ï¼Œå› ä¸ºæ‰§è¡Œ`systemctl enable sshd.service`å‘½ä»¤æ—¶ï¼Œ`sshd.service`çš„ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œå°±ä¼šæ”¾åœ¨`/etc/systemd/system`ç›®å½•ä¸‹é¢çš„`multi-user.target.wants`å­ç›®å½•ä¹‹ä¸­ã€‚

Systemd æœ‰é»˜è®¤çš„å¯åŠ¨ Targetã€‚

 ```bash
 $ systemctl get-default
 multi-user.target
 ```

ä¸€èˆ¬æ¥è¯´ï¼Œå¸¸ç”¨çš„ Target æœ‰ä¸¤ä¸ªï¼šä¸€ä¸ªæ˜¯`multi-user.target`ï¼Œè¡¨ç¤ºå¤šç”¨æˆ·å‘½ä»¤è¡ŒçŠ¶æ€ï¼›å¦ä¸€ä¸ªæ˜¯`graphical.target`ï¼Œè¡¨ç¤ºå›¾å½¢ç”¨æˆ·çŠ¶æ€ï¼Œå®ƒä¾èµ–äº`multi-user.target`ã€‚å®˜æ–¹æ–‡æ¡£æœ‰ä¸€å¼ éå¸¸æ¸…æ™°çš„ [Target ä¾èµ–å…³ç³»å›¾](https://www.freedesktop.org/software/systemd/man/bootup.html#System Manager Bootup)ã€‚

Target ä¹Ÿæœ‰è‡ªå·±çš„é…ç½®æ–‡ä»¶ã€‚

```bash
$ systemctl cat multi-user.target

[Unit]
Description=Multi-User System
Documentation=man:systemd.special(7)
Requires=basic.target
Conflicts=rescue.service rescue.target
After=basic.target rescue.service rescue.target
AllowIsolate=yes
```

## è¯¦ç»†çš„å­—æ®µè§£é‡Š

```
[Unit]
Description : æœåŠ¡çš„ç®€å•æè¿°
Documentation ï¼š æœåŠ¡æ–‡æ¡£
Beforeã€After:å®šä¹‰å¯åŠ¨é¡ºåºã€‚Before=xxx.service,ä»£è¡¨æœ¬æœåŠ¡åœ¨xxx.serviceå¯åŠ¨ä¹‹å‰å¯åŠ¨ã€‚After=xxx.service,ä»£è¡¨æœ¬æœåŠ¡åœ¨xxx.serviceä¹‹åå¯åŠ¨ã€‚
Requiresï¼šè¿™ä¸ªå•å…ƒå¯åŠ¨äº†ï¼Œå®ƒéœ€è¦çš„å•å…ƒä¹Ÿä¼šè¢«å¯åŠ¨ï¼›å®ƒéœ€è¦çš„å•å…ƒè¢«åœæ­¢äº†ï¼Œè¿™ä¸ªå•å…ƒä¹Ÿåœæ­¢äº†ã€‚
Wantsï¼šæ¨èä½¿ç”¨ã€‚è¿™ä¸ªå•å…ƒå¯åŠ¨äº†ï¼Œå®ƒéœ€è¦çš„å•å…ƒä¹Ÿä¼šè¢«å¯åŠ¨ï¼›å®ƒéœ€è¦çš„å•å…ƒè¢«åœæ­¢äº†ï¼Œå¯¹æœ¬å•å…ƒæ²¡æœ‰å½±å“ã€‚
```

```
[Service]
Type=simpleï¼ˆé»˜è®¤å€¼ï¼‰ï¼šsystemdè®¤ä¸ºè¯¥æœåŠ¡å°†ç«‹å³å¯åŠ¨ã€‚æœåŠ¡è¿›ç¨‹ä¸ä¼šforkã€‚å¦‚æœè¯¥æœåŠ¡è¦å¯åŠ¨å…¶ä»–æœåŠ¡ï¼Œä¸è¦ä½¿ç”¨æ­¤ç±»å‹å¯åŠ¨ï¼Œé™¤éè¯¥æœåŠ¡æ˜¯socketæ¿€æ´»å‹ã€‚
Type=forkingï¼šsystemdè®¤ä¸ºå½“è¯¥æœåŠ¡è¿›ç¨‹forkï¼Œä¸”çˆ¶è¿›ç¨‹é€€å‡ºåæœåŠ¡å¯åŠ¨æˆåŠŸã€‚å¯¹äºå¸¸è§„çš„å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰ï¼Œé™¤éä½ ç¡®å®šæ­¤å¯åŠ¨æ–¹å¼æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œä½¿ç”¨æ­¤ç±»å‹å¯åŠ¨å³å¯ã€‚ä½¿ç”¨æ­¤å¯åŠ¨ç±»å‹åº”åŒæ—¶æŒ‡å®š PIDFile=ï¼Œä»¥ä¾¿systemdèƒ½å¤Ÿè·Ÿè¸ªæœåŠ¡çš„ä¸»è¿›ç¨‹ã€‚
Type=oneshotï¼šè¿™ä¸€é€‰é¡¹é€‚ç”¨äºåªæ‰§è¡Œä¸€é¡¹ä»»åŠ¡ã€éšåç«‹å³é€€å‡ºçš„æœåŠ¡ã€‚å¯èƒ½éœ€è¦åŒæ—¶è®¾ç½® RemainAfterExit=yes ä½¿å¾— systemd åœ¨æœåŠ¡è¿›ç¨‹é€€å‡ºä¹‹åä»ç„¶è®¤ä¸ºæœåŠ¡å¤„äºæ¿€æ´»çŠ¶æ€ã€‚
Type=notifyï¼šä¸ Type=simple ç›¸åŒï¼Œä½†çº¦å®šæœåŠ¡ä¼šåœ¨å°±ç»ªåå‘ systemd å‘é€ä¸€ä¸ªä¿¡å·ã€‚è¿™ä¸€é€šçŸ¥çš„å®ç°ç”± libsystemd-daemon.so æä¾›ã€‚
Type=dbusï¼šè‹¥ä»¥æ­¤æ–¹å¼å¯åŠ¨ï¼Œå½“æŒ‡å®šçš„ BusName å‡ºç°åœ¨DBusç³»ç»Ÿæ€»çº¿ä¸Šæ—¶ï¼Œsystemdè®¤ä¸ºæœåŠ¡å°±ç»ªã€‚
Type=idle: systemdä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡(Jobs)å¤„ç†å®Œæˆåï¼Œæ‰å¼€å§‹æ‰§è¡Œidleç±»å‹çš„å•å…ƒã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå…¶ä»–è¡Œä¸ºå’ŒType=simple ç±»ä¼¼ã€‚
PIDFileï¼špidæ–‡ä»¶è·¯å¾„
ExecStartPreï¼šåœæ­¢æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤
ExecStartï¼šæŒ‡å®šå¯åŠ¨å•å…ƒçš„å‘½ä»¤æˆ–è€…è„šæœ¬ï¼ŒExecStartPreå’ŒExecStartPostèŠ‚æŒ‡å®šåœ¨ExecStartä¹‹å‰æˆ–è€…ä¹‹åç”¨æˆ·è‡ªå®šä¹‰æ‰§è¡Œçš„è„šæœ¬ã€‚Type=oneshotå…è®¸æŒ‡å®šå¤šä¸ªå¸Œæœ›é¡ºåºæ‰§è¡Œçš„ç”¨æˆ·è‡ªå®šä¹‰å‘½ä»¤ã€‚
ExecReloadï¼šæŒ‡å®šå•å…ƒåœæ­¢æ—¶æ‰§è¡Œçš„å‘½ä»¤æˆ–è€…è„šæœ¬ã€‚
ExecStopï¼šæŒ‡å®šå•å…ƒåœæ­¢æ—¶æ‰§è¡Œçš„å‘½ä»¤æˆ–è€…è„šæœ¬ã€‚
ExecStopPostï¼šåœæ­¢æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤
ExecStartPostï¼šå¯åŠ¨æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤
PrivateTmpï¼šTrueè¡¨ç¤ºç»™æœåŠ¡åˆ†é…ç‹¬ç«‹çš„ä¸´æ—¶ç©ºé—´
Restartï¼šè¿™ä¸ªé€‰é¡¹å¦‚æœè¢«å…è®¸ï¼ŒæœåŠ¡é‡å¯çš„æ—¶å€™è¿›ç¨‹ä¼šé€€å‡ºï¼Œä¼šé€šè¿‡systemctlå‘½ä»¤æ‰§è¡Œæ¸…é™¤å¹¶é‡å¯çš„æ“ä½œã€‚
RemainAfterExitï¼šå¦‚æœè®¾ç½®è¿™ä¸ªé€‰æ‹©ä¸ºçœŸï¼ŒæœåŠ¡ä¼šè¢«è®¤ä¸ºæ˜¯åœ¨æ¿€æ´»çŠ¶æ€ï¼Œå³ä½¿æ‰€ä»¥çš„è¿›ç¨‹å·²ç»é€€å‡ºï¼Œé»˜è®¤çš„å€¼ä¸ºå‡ï¼Œè¿™ä¸ªé€‰é¡¹åªæœ‰åœ¨Type=oneshotæ—¶éœ€è¦è¢«é…ç½®ã€‚
```

```
[Install]
Aliasï¼šä¸ºå•å…ƒæä¾›ä¸€ä¸ªç©ºé—´åˆ†ç¦»çš„é™„åŠ åå­—ã€‚
RequiredByï¼šå•å…ƒè¢«å…è®¸è¿è¡Œéœ€è¦çš„ä¸€ç³»åˆ—ä¾èµ–å•å…ƒï¼ŒRequiredByåˆ—è¡¨ä»Requireè·å¾—ä¾èµ–ä¿¡æ¯ã€‚
WantByï¼šå•å…ƒè¢«å…è®¸è¿è¡Œéœ€è¦çš„å¼±ä¾èµ–æ€§å•å…ƒï¼ŒWantbyä»Wantåˆ—è¡¨è·å¾—ä¾èµ–ä¿¡æ¯ã€‚
Alsoï¼šæŒ‡å‡ºå’Œå•å…ƒä¸€èµ·å®‰è£…æˆ–è€…è¢«ååŠ©çš„å•å…ƒã€‚
DefaultInstanceï¼šå®ä¾‹å•å…ƒçš„é™åˆ¶ï¼Œè¿™ä¸ªé€‰é¡¹æŒ‡å®šå¦‚æœå•å…ƒè¢«å…è®¸è¿è¡Œé»˜è®¤çš„å®ä¾‹ã€‚
```

## é‡å¯

```bash
# é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶
$ sudo systemctl daemon-reload

# é‡å¯ç›¸å…³æœåŠ¡
$ sudo systemctl restart foobar
```
>>>>>>> master
