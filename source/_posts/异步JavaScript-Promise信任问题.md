---
title: å¼‚æ­¥JavaScript-Promiseä¿¡ä»»é—®é¢˜
date: 2021-07-16 18:50:04
tags: JavaScript
categories: ç¬”è®°
url: asynchronous-javascript-trust-promise
---

ç»§å‰ç¯‡ [å¼‚æ­¥JavaScript-çŽ°åœ¨ä¸Žå°†æ¥ | ðŸ­Defectink](/defect/asynchronous-javascript-now-and-future.html) å¯¹å¼‚æ­¥ JavaScript æœ‰äº†ä¸ªå¤§æ¦‚çš„äº†è§£ä¹‹åŽï¼Œå°±è¦æ¥çœŸæ­£çš„ä¸Šæ‰‹ä¸€ä¸‹ Promise äº†ã€‚ä½†åœ¨äº†è§£ Promise è§£å†³äº†å“ªäº›é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬è¦å…ˆäº†è§£ä¸€ä¸‹ä¼ ç»Ÿçš„å›žè°ƒä¼šå¸¦æ¥å“ªäº›é—®é¢˜ã€‚

## å›žè°ƒä¿¡ä»»é—®é¢˜

å›žè°ƒä¸ºä»€ä¹ˆä¼šæœ‰ä¿¡ä»»é—®é¢˜ï¼Ÿå›žè°ƒçš„æœ¬è´¨å°±æ˜¯ç­‰å¾…å°†æ¥æ‰§è¡Œå®Œæˆçš„äº‹ä»¶æ¥æ‰§è¡Œæˆ‘ä»¬æ‰€å‡†å¤‡çš„å‡½æ•°ã€‚

```js
// A
ajax('url.1', () => {
  // B
});
// C
```

A ä¸Ž B éƒ¨åˆ†çš„å—æ˜¯åŒæ­¥çš„ï¼Œå‘ç”ŸäºŽçŽ°åœ¨ï¼Œåœ¨ JavaScript ä¸»ç¨‹åºçš„æŽ§åˆ¶ä¹‹ä¸‹ã€‚ä½† C ç¨‹åºå—å°†å»¶è¿Ÿæ‰§è¡Œï¼Œå¹¶ä¸”ç”±ï¼ˆè™šæž„çš„ï¼‰ajax å‡½æ•°æ¥è°ƒç”¨ã€‚è¿™å°±æ˜¯ä¸€ç§æŽ§åˆ¶è½¬ç§»ï¼Œç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œè¿™ç§æŽ§åˆ¶è½¬ç§»é€šå¸¸ä¸ä¼šç»™ç¨‹åºå¸¦æ¥ä»»ä½•é—®é¢˜ã€‚

ä½†å®žé™…ä¸Šï¼Œå›žè°ƒå¸¦æ¥çš„ä¿¡ä»»é—®é¢˜æ­£æ˜¯ç”±è¿™ç§æŽ§åˆ¶åè½¬ï¼ˆinversion of controlï¼‰å¸¦æ¥çš„ã€‚

### å“ªäº›é—®é¢˜

å¯¹äºŽå›žè°ƒçš„ä¿¡ä»»é—®é¢˜ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºŽï¼š

* è°ƒç”¨å›žè°ƒè¿‡æ—©ï¼›
* è°ƒç”¨å›žè°ƒè¿‡æ™šï¼›
* è°ƒç”¨å›žè°ƒæ¬¡æ•°è¿‡å°‘æˆ–æˆ–å¤šï¼›
* å‚æ•°/çŽ¯å¢ƒå€¼æœªä¼ é€’ï¼›
* åžæŽ‰å¯èƒ½å‡ºçŽ°çš„é”™è¯¯æˆ–å¼‚å¸¸ï¼›

ç­‰ã€‚

äººä»¬ç”¨è™šæž„çš„æ¶é­” Zalgo æ¥æè¿°è¿™ç§åŒæ­¥/å¼‚æ­¥çš„å™©æ¢¦ï¼Œåœ¨ [Don't release Zalgo!](https://oren.github.io/articles/zalgo/) ä¸€æ–‡ä¸­ï¼Œé’ˆå¯¹å›žè°ƒä¿¡ä»»é—®é¢˜çš„æè¿°ä¸ºï¼š

> When you write a function that accept a callback, make sure your function always sync or always async. don't mix the two.

å½“æˆ‘ä»¬æœ‰ä¸€ä¸ªæŽ¥æ”¶å›žè°ƒçš„å‡½æ•°æ—¶ï¼Œè¦ç¡®ä¿è¯¥å‡½æ•°æ‹¥æœ‰ä»¥å¼‚æ­¥æˆ–åŒæ­¥çš„æ–¹å¼è¿è¡Œï¼ŒäºŒè€…ä¸èƒ½æ··æ·†ã€‚å¦‚æžœè¯¥å‡½æ•°è¿è¡Œçš„æ–¹å¼æ— æ³•ç¡®å®šï¼Œå°±ä¼šå‡ºçŽ°å›žè°ƒè¿‡æ—©ï¼Œè¿‡æ™šç­‰æƒ…å†µã€‚

è¿™äº›æƒ…å†µä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿè¿™æ˜¯ä¸€æ®µä¼ªä»£ç ï¼š

```js
function result(data) {
  console.log(a);
}

let a = 0;

ajax('url.1', result);

a++;
```

å‡è®¾è™šæž„çš„ ajax å‡½æ•°æ— æ³•ç¡®å®šå®ƒæ—¶åŒæ­¥æ‰§è¡Œï¼ˆä»Žç¼“å­˜è¯»å–ï¼‰è¿˜æ˜¯å¼‚æ­¥æ‰§è¡Œï¼ˆå‘é€ä¸€ä¸ªæ–°çš„è¯·æ±‚ï¼‰ï¼Œè¿™å°±å¯¼è‡´äº† result å‡½æ•°æ‰“å° a çš„å€¼å˜çš„ä¸ç¡®å®šã€‚å¦‚æžœæ˜¯åŒæ­¥çš„ï¼Œåˆ™ a = 0ï¼›åä¹‹ï¼Œa = 1ï¼›

è¿™è¿˜åªæ˜¯å¤šä¸ªä¿¡ä»»é—®é¢˜ä¸­çš„ä¸€ä¸ªï¼Œåœ¨ JavaScript é«˜é€Ÿå‘å±•çš„ä»Šå¤©ï¼Œå¯¹äºŽå¼‚æ­¥æ¥è¯´ï¼Œå›žè°ƒå‡½æ•°å·²ç»ä¸å¤Ÿç”¨äº†ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´å¥½çš„å¼‚æ­¥ç¼–ç¨‹æ–¹å¼ï¼Œä¸€ç§æ›´åŒæ­¥ã€æ›´é¡ºåºã€æ›´é˜»å¡žçš„æ–¹å¼æ¥è¡¨è¾¾å¼‚æ­¥ï¼Œå°±åƒæˆ‘ä»¬çš„å¤§è„‘ä¸€æ ·ã€‚

## Promise

ES6 ä¸ºæˆ‘ä»¬å¸¦æ¥äº†æ–°çš„å¼‚æ­¥æ¦‚å¿µï¼Œå³ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå¾®ä»»åŠ¡ï¼‰ã€‚Promise API å°±æ˜¯åŸºäºŽå¾®ä»»åŠ¡ä¹‹ä¸Šçš„ï¼Œå®ƒèƒ½å¤Ÿæ›´å¥½çš„å¤„ç†å›žè°ƒæ‰€å¸¦æ¥çš„ä¿¡ä»»é—®é¢˜ã€‚

> Promise æ˜¯ä¸€ä¸ªå¾ˆä¼˜ç§€çš„ APIï¼Œåˆ°å¤„éƒ½èƒ½çœ‹åˆ°å®ƒçš„è¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œä¾¿ä¸å†å¤šè´¹å£èˆŒã€‚

### è°ƒç”¨è¿‡æ—©

æ ¹æ®ä¸Šè¿°çš„ Zalgo æ‰€å¸¦æ¥çš„é—®é¢˜ï¼Œè°ƒç”¨è¿‡æ—©ä¸»è¦çš„æ ¹æœ¬åŽŸå› å°±æ˜¯æˆ‘ä»¬æ— æ³•ç¡®å®šå›žè°ƒå‡½æ•°æ˜¯ä»¥åŒæ­¥çš„æ–¹å¼è¿˜æ˜¯å¼‚æ­¥çš„æ–¹å¼æ‰§è¡Œçš„ã€‚è€Œ Promise æœ¬èº«å°±ä¸å¿…æ‹…å¿ƒè¿™ä¸ªé—®é¢˜ï¼Œæ ¹æ®ä»»åŠ¡é˜Ÿåˆ—çš„å®šä¹‰ï¼Œå³ä¾¿æ˜¯ç«‹å³å®Œæˆçš„ Promise `Promise.resolve(42)` ä¹Ÿæ— æ³•è¢«åŒæ­¥æ‰€å¯Ÿè§‰åˆ°ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹ä¸€ä¸ª Promise è°ƒç”¨`then(...)`çš„æ—¶å€™ï¼Œå³ä½¿è¿™ä¸ª Promise å·²ç» resolveï¼Œæä¾›ç»™`then(...)`çš„å›žè°ƒä¹Ÿæ€»æ˜¯ä¼šå¼‚æ­¥è°ƒç”¨ã€‚å› ä¸ºè¿™å°±æ˜¯å®ä»»åŠ¡ä¸Žå¾®ä»»åŠ¡çš„è¿è¡Œæ–¹å¼ï¼š [ä»»åŠ¡ | ðŸ­Defectink](/defect/asynchronous-javascript-now-and-future.html#ä»»åŠ¡)

```js
console.log(41);

Promise.resolve(42).then((val) => {
  console.log(val);
});

console.log(43);
// 41 43 42
```

### è°ƒç”¨è¿‡æ™š

å’Œè°ƒç”¨è¿‡æ—©ç±»ä¼¼ï¼Œæ ¹æ®å¾®ä»»åŠ¡çš„å®šä¹‰ï¼Œä¸€ä¸ª Promise è¢« resolve æˆ–è€… reject åŽï¼Œä¸€å®šä¼šåœ¨å½“å‰å®ä»»åŠ¡åŽæ·»åŠ åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚è¿™å°±ç¡®ä¿äº†æ³¨å†Œåœ¨ Promise ä¸Šçš„å›žè°ƒåœ¨ä¸‹ä¸ªå®ä»»åŠ¡å¼€å§‹ä¹‹å‰ä¸€å®šä¼šè¢«ä¾æ¬¡è°ƒç”¨ï¼Œå¹¶ä¸”ä»–ä»¬ä¸­çš„ä»»æ„ä¸€ä¸ªéƒ½æ— æ³•å½±å“æˆ–å»¶è¯¯å¯¹å…¶ä»–å›žè°ƒçš„è°ƒç”¨ã€‚

```js
p.then((val) => {
  p.then((val) => {
    console.log('C');
  });
  console.log('A');
});
p.then((val) => {
  console.log('B');
});
// A B C
```

è¿™é‡Œçš„ä¸‰ä¸ªå¾®ä»»åŠ¡ï¼ŒC æ°¸è¿œæ— æ³•æ‰“æ–­æˆ–æŠ¢å  Bï¼Œè¿™æ˜¯å› ä¸º Promise çš„è¿ä½œæ–¹å¼ã€‚

#### è°ƒåº¦æŠ€å·§

å¾®ä»»åŠ¡è™½ç„¶ç»™æˆ‘ä»¬å¸¦æ¥äº†ä¸å°‘å¥½å¤„ï¼Œä½†ä¹Ÿæœ‰å¾ˆå¤šè°ƒåº¦çš„ç»†å¾®å·®åˆ«ã€‚å¦‚æžœä¸¤ä¸ª Promise p1 å’Œ p2 éƒ½å·²ç» resolveï¼Œé‚£ä¹ˆæ³¨å†Œåœ¨ p1 ä¸Šçš„`then(...)`å›žè°ƒé€šå¸¸åº”è¯¥å…ˆäºŽ p2 æ‰€æ³¨å†Œçš„å›žè°ƒæ‰§è¡Œã€‚ä½†æŸäº›ç»†å¾®çš„åœºæ™¯ä¸‹å¯èƒ½ä¸æ˜¯å¦‚æ­¤ï¼š

```js
const p3 = new Promise((resolve) => {
  resolve('B');
});
const p1 = new Promise((resolve) => {
  resolve(p3);
});
const p2 = new Promise((resolve) => {
  resolve('A');
});

p1.then((val) => {
  console.log(val);
});
p2.then((val) => {
  console.log(val);
});
// A B
```

ç”±äºŽ p1 ä¸æ˜¯ç«‹å³å€¼ï¼Œ è€Œæ˜¯ resolve å¦ä¸€ä¸ª Promise p3ã€‚è§„å®šçš„è¡Œä¸ºæ˜¯æŠŠ p3 å±•å¼€åˆ° p1ï¼Œä½†æ˜¯æ˜¯å¼‚æ­¥çš„å±•å¼€ï¼Œæ‰€ä»¥è¿™é‡Œçš„ p2 çš„å›žè°ƒå…ˆæ‰§è¡Œã€‚

> å¦‚æžœ p1 æ˜¯`Promise.resolve()`ï¼Œç»“æžœåˆ™ä¸åŒï¼Œå®ƒä¼šè¿”å›žåŒä¸€ä¸ª Promiseã€‚

### å›žè°ƒæœªè°ƒç”¨

ç›®å‰æ²¡æœ‰ä»»ä½•åŠžæ³•èƒ½å¤Ÿé˜»æ­¢ Promise å‘æˆ‘ä»¬é€šçŸ¥å®ƒçš„å†³è®®ï¼ˆresolve æˆ–è€… rejectï¼‰ã€‚å¦‚æžœæˆ‘ä»¬å¯¹ Promise æ³¨å†Œäº†å›žè°ƒçš„è¯ï¼Œé‚£ä¹ˆå®ƒåœ¨å†³è®®æ—¶ï¼Œæ€»æ˜¯ä¼šè°ƒç”¨å›žè°ƒå‡½æ•°ï¼ˆå®Œæˆå›žè°ƒæˆ–æ‹’ç»å›žè°ƒä¸­çš„ä¸€ä¸ªï¼‰ã€‚

> å†³è®®ä¸€è¯å‚è€ƒè‡ªã€Šä½ ä¸çŸ¥çš„ JavaScript ä¸­å·ã€‹ä¸­æ–‡ç‰ˆï¼Œè¿™ä¹Ÿæ˜¯æœ¬æ–‡å¯¹ Promise resolve æˆ– reject çš„è¡¨è¾¾è¯ã€‚

ä½†å¦‚æžœå›žè°ƒæ°¸è¿œä¸ä¼šè¢«å†³è®®å‘¢ï¼ŸPromise ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç«žæ€çš„é«˜çº§æŠ½è±¡æœºåˆ¶çš„ APIï¼š`Promise.race()`ã€‚

```js
const timeoutPromise = (delay) => {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      reject('Timeout!');
    }, delay);
  });
};

// å‡è®¾ foo ä¸ä¼šè¢«å†³è®®
// å°è¯•ç»™å®ƒ 3000ms
Promise.race([foo(), timeoutPromise(3000)])
  .then((val) => {
    console.log('foo done');
  })
  .catch((e) => {
    console.log(e);
  });
```

åˆ©ç”¨è¯¥ APIï¼Œå³ä¾¿ç›®æ ‡ Promise æ°¸è¿œä¸ä¼šè¢«å†³è®®ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½ä¸ºå…¶è®¾ç½®è¶…æ—¶å¹¶é˜²æ­¢å®ƒæ°¸ä¹…é˜»å¡žç¨‹åºã€‚

> è¿™é‡Œå¦‚æžœ foo æ˜¯å¾®ä»»åŠ¡æ­»å¾ªçŽ¯çš„è¯ï¼Œrace ä¹Ÿæ— èƒ½ä¸ºåŠ›ï¼

### è°ƒç”¨æ¬¡æ•°è¿‡å°‘/è¿‡å¤š

æ­£å¸¸æƒ…å†µä¸‹çš„è°ƒç”¨æ¬¡æ•°åº”è¯¥æ˜¯ 1 æ¬¡ï¼Œè°ƒç”¨æ¬¡æ•°è¿‡å°‘ä¹Ÿå°±æ˜¯ 0 æ¬¡ï¼Œè¿™ä¸Žä¸Šè¿°å›žè°ƒæœªè°ƒç”¨æ˜¯ä¸€ä¸ªæ„æ€ã€‚å‰©ä¸‹çš„å°±æ˜¯è°ƒç”¨æ¬¡æ•°è¿‡å¤šäº†ã€‚

æœ¬è´¨ä¸Šï¼ŒPromise çš„å®šä¹‰æ–¹å¼ä½¿å¾—å®ƒåªèƒ½è¢«å†³è®®ä¸€æ¬¡ã€‚å¦‚æžœå‡ºçŽ°æŸç§æƒ…å†µï¼Œæˆ‘ä»¬çš„ä»£ç è¯•å›¾è°ƒç”¨`resolve(...)`æˆ–`reject(...)`å¤šæ¬¡ï¼Œæˆ–è€…è¯•å›¾äºŒè€…éƒ½è°ƒç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ª Promise åªä¼šæŽ¥æ”¶ç¬¬ä¸€æ¬¡å†³è®®ï¼Œå¹¶é»˜é»˜çš„å¿½ç•¥åŽç»­çš„ä»»ä½•è°ƒç”¨ã€‚

ç”±äºŽ Promise åªèƒ½è¢«å†³è®®ä¸€æ¬¡ï¼Œä»»ä½•é€šè¿‡`then(...)`æ³¨å†Œçš„å›žè°ƒåªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚è¿™æ˜¯åœ¨é“¾å¼è°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œå¤šæ¬¡æ³¨å†Œ then å›žè°ƒï¼ˆ`p.then(); p.then()`ï¼‰æ—¶ï¼Œå®ƒçš„è°ƒç”¨æ¬¡æ•°ä¸Žæ³¨å†Œæ¬¡æ•°ç›¸åŒã€‚

### æœªèƒ½ä¼ é€’å‚æ•°/çŽ¯å¢ƒå€¼

Promise æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªå†³è®®å€¼ï¼Œå®Œæˆæˆ–æ‹’ç»ã€‚

å¦‚æžœæ²¡æœ‰æ‰‹åŠ¨å†³è®®ä»»ä½•å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼å°±æ˜¯ undefinedã€‚å¦‚æžœå†³è®®æ—¶ä¼ é€’äº†å¤šä¸ªå‚æ•°ï¼Œå‰©ä½™çš„å‚æ•°éƒ½ä¼šè¢«é»˜é»˜å¿½ç•¥ã€‚å¦‚æžœéœ€è¦ä¼ é€’å¤šä¸ªå€¼ï¼Œåˆ™éœ€è¦å°è£…ä¸ºä¸€ä¸ªå¯¹è±¡æˆ–æ•°ç»„ã€‚

å¯¹äºŽçŽ¯å¢ƒå€¼æ¥è¯´ï¼Œæˆ‘ä»¬æä¾›çš„å›žè°ƒå‡½æ•°ä¾ç„¶å¯ä»¥è®¿é—®å¯¹åº”çš„ä½œç”¨åŸŸå’Œé—­åŒ…ã€‚

### åžæŽ‰é”™è¯¯æˆ–å¼‚å¸¸

å¦‚æžœæ‹’ç»ä¸€ä¸ª Promise å¹¶ç»™å‡ºä¸€ä¸ªç†ç”±ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼å°±ä¼šä¼ ç»™æ‹’ç»å›žè°ƒã€‚

å¦‚æžœ Promise åœ¨åˆ›å»ºæˆ–å†³è®®çš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯ï¼Œé‚£è¿™ä¸ªé”™è¯¯å°±ä¼šè¢«æ•æ‰ï¼Œå¹¶ä¸”ä½¿è¿™ä¸ª Promise è¢«æ‹’ç»ã€‚

```js
const p = new Promise((resolve, reject) => {
  foo.bar(); // é”™è¯¯ï¼foo æœªå®šä¹‰
  resolve(42);
});

p.then(
  (val) => {
    console.log(val);
  },
  (err) => {
    console.log(err); // åœ¨è¿™é‡Œæ•èŽ·é”™è¯¯
  }
);
```

è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é˜²æ­¢ Zalgo å‡ºçŽ°çš„æœºåˆ¶ã€‚`then(...)`å¯ä»¥æ³¨å†Œä¸¤ä¸ªå›žè°ƒï¼Œä¸€ä¸ªæˆåŠŸæ—¶è°ƒç”¨ï¼Œä¸€ä¸ªå‡ºé”™æ—¶è°ƒç”¨ã€‚è¿™å’Œä»¥å‰å›žè°ƒå‡½æ•°çš„æ–¹å¼å¥½ä¼¼ç›¸åŒã€‚ä½†å¦‚æžœåœ¨å›žè°ƒæœŸé—´å‡ºçŽ°çš„é”™è¯¯å°±æ— æ³•è¢«å½“å‰`then(...)`ä¸­çš„å¦ä¸€ä¸ªå¤±è´¥å›žè°ƒæ‰€æ•èŽ·ï¼Œè¿™çœ‹ä¼¼é˜²æŠ¤å°±æ˜¯é”™è¯¯è¢«åžæŽ‰äº†ã€‚å¥½åœ¨ï¼ŒçŽ°åœ¨çš„ Promise è¿˜æ”¯æŒå’Œ`try...catch...`ç±»ä¼¼çš„æ–¹å¼é˜²æ­¢åžæŽ‰é”™è¯¯ã€‚

```js
const p1 = new Promise((resolve) => {
  resolve(42);
});

p1.then((val) => {
  foo.bar();
  console.log(val);
})
  .catch((err) => {
    console.log('Catch in catch');
    console.log(err);
  })
  .finally(() => {
    cleanFunc();
  });
```

## æ˜¯å¯ä¿¡ä»»çš„Promiseå—

Promise çœ‹ä¸ŠåŽ»è§£å†³äº†ä¸å°‘å›žè°ƒæ— æ³•è¢«ä¿¡ä»»çš„é—®é¢˜ï¼Œé‚£ä¹ˆ Promise æ˜¯å®Œå…¨å¯ä¿¡çš„å—ï¼Ÿåœ¨æ­¤ä¹‹å‰ï¼Œå¾—å…ˆçœ‹å¦ä¸€ä¸ªé—®é¢˜ã€‚

### thenable çš„é¸­å­ç±»åž‹

> å½“çœ‹åˆ°ä¸€åªé¸Ÿèµ°èµ·æ¥åƒé¸­å­ã€æ¸¸æ³³èµ·æ¥åƒé¸­å­ã€å«èµ·æ¥ä¹Ÿåƒé¸­å­ï¼Œé‚£ä¹ˆè¿™åªé¸Ÿå°±å¯ä»¥è¢«ç§°ä¸ºé¸­å­ã€‚

å¸¸è§çš„ Promise éƒ½æ˜¯ç”±å…¶æž„é€ å‡½æ•°å®žä¾‹åŒ–è€Œæ¥ï¼Œæˆ–è®¸æˆ‘ä»¬å¯ä»¥é€šè¿‡`p instanceof Promise`æ¥æ£€æŸ¥æŸæ ·ä¸œè¥¿æ˜¯å¦æ˜¯çœŸæ­£çš„ Promiseã€‚ä½†è¿™ä¸ªæ–¹æ³•å¹¶ä¸å®Œå–„ï¼Œå¦‚æžœ Promise æ¥è‡ªå…¶ä»–çª—å£æˆ–æŸä¸ªè‡ªå·±å®žçŽ° Promise çš„åº“ä¸­ï¼Œæˆ‘ä»¬å°±æ— æ³•åˆ¤æ–­å…¶æ˜¯å¦æ˜¯çœŸæ­£å¯ç”¨çš„ Promiseã€‚

ä¾‹å¦‚è¿™æ ·çš„ thenable ç±»åž‹å¯¹è±¡ï¼Œå®ƒå¯èƒ½ç±»ä¼¼äºŽ Promise çš„æ–¹å¼å·¥ä½œå®Œå…¨å°±æ˜¯ä¾¥å¹¸ã€‚

```js
const p = {
  then(cb, ecb) {
    cb(42);
  },
};

p.then((val) => {
  console.log(val); // 42
});
```

å¦‚æžœæƒ…å†µæ˜¯è¿™æ ·ï¼Œé‚£ä¹ˆåœ¨ thenable çš„å¯¹è±¡ä¸Šæ³¨å†Œçš„å›žè°ƒéƒ½ä¼šè¢«æ‰§è¡Œï¼Œè¿™æ ·çš„è¡Œä¸ºå’Œ Promise å®Œå…¨ä¸ä¸€è‡´ã€‚

```js
const p = {
  then(cb, ecb) {
    cb(42);
    ecb('evil laugh');
  },
};

p.then(
  (val) => {
    console.log(val); // 42
  },
  (err) => {
    console.log(err); // åŒæ ·ä¹Ÿè¢«æ‰§è¡Œäº†ï¼
  }
);
```

å¥½åœ¨ï¼ŒPromise ç»™äº†æˆ‘ä»¬è§£å†³åŠžæ³•ï¼š`Promise.resolve()`ã€‚`Promise.resolve()`å¯ä»¥æŽ¥æ”¶ä»»ä½• thenable çš„å€¼ï¼Œå°†å…¶è§£å°ä¸ºå®ƒçš„éž thenable å€¼ã€‚ä»Ž`Promise.resolve()`å¾—åˆ°çš„å€¼å°†æ˜¯ä¸€ä¸ªçœŸæ­£çš„ Promiseã€‚

```js
Promise.resolve(p).then(
  (val) => {
    console.log(val); // 42
  },
  (err) => {
    console.log(err); // æ²¡æœ‰è¢«æ‰§è¡Œï¼
  }
);
```

æ‰€ä»¥åœ¨é¢å¯¹æ— æ³•ä¿¡ä»»çš„ Promise æ—¶ï¼Œå¯ä»¥ä½¿ç”¨`Promise.resolve()`å¯¹å…¶è¿›è¡Œå°è£…ï¼Œå°†å…¶å˜æˆçœŸæ­£çš„ Promiseã€‚

### å¦å¤–çš„è°ƒåº¦æŠ€å·§

åœ¨ä¸Šè¿°è°ƒåº¦æŠ€å·§ä¸­ï¼Œp1 å¦‚æžœ resolve p3ï¼Œåˆ™éœ€è¦åœ¨ä¸‹ä¸€ä¸ªå¼‚æ­¥ä¸­å°†å…¶å±•å¼€ã€‚

```js
const p3 = new Promise((resolve) => {
  resolve('B');
});
const p1 = new Promise((resolve) => {
  resolve(p3);
});

p1.then((val) => {
  console.log(val);
});
```

è€Œä½¿ç”¨`Promise.resolve()`åˆ™ä¼šç«‹å³è¿”å›žä¸€ä¸ªç›¸åŒçš„ Promiseã€‚

```js
const p3 = new Promise((resolve) => {
  resolve(42);
});

const p1 = Promise.resolve(p3);

console.log(p1 === p3); // true
```

